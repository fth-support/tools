<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Log Analyzer V5.1 - Full Dashboard Excel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --bg-color: #f8f9fa;
            --success: #1e8e3e;
            --info: #03a9f4;
            --normal: #673ab7;
            --warning: #f57c00;
            --danger: #d93025;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; }
        
        .header-upload { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1100; }
        .export-btn { 
            background: #1d6f42; color: white; border: none; padding: 8px 18px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .sticky-top-area { position: sticky; top: 60px; z-index: 1000; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-bar, .sla-bar { display: flex; border-bottom: 1px solid #eee; }
        .chart-bar { padding: 10px 20px; height: 180px; }

        .card-stat { text-align: center; flex: 1; padding: 8px 5px; border-right: 1px solid #eee; }
        .card-stat:last-child { border-right: none; }
        .card-stat small { display: block; color: #666; font-size: 0.7em; font-weight: bold; text-transform: uppercase; }
        .card-stat strong { font-size: 1.15em; color: var(--primary-color); }

        .container { width: 100%; margin: 0; padding: 0; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        
        thead th { 
            background: var(--primary-color); color: white; position: sticky; 
            z-index: 999; padding: 12px 15px; text-align: left; font-size: 0.9em;
        }

        td { padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-idx { width: 60px; text-align: center; }
        .col-req, .col-res { width: 35%; }
        .col-dur { width: 20%; text-align: right; }
        
        .slow-warn { color: var(--warning); font-weight: bold; }
        .slow-danger { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="header-upload">
    <strong>Log Analyzer V5.1</strong> | 
    <input type="file" id="fileInput" accept=".log,.txt">
    <button id="exportBtn" class="export-btn" style="display:none;" onclick="exportToExcelPro()">✨ Export Report to Excel</button>
</div>

<div id="mainContent" style="display:none;">
    <div class="sticky-top-area" id="stickyArea">
        <div class="stats-bar">
            <div class="card-stat"><small>เฉลี่ย (AVG)</small><strong id="avgVal">-</strong> ms</div>
            <div class="card-stat"><small>เร็วสุด (MIN)</small><strong id="minVal" style="color: var(--success);">-</strong> ms</div>
            <div class="card-stat"><small>ช้าสุด (MAX)</small><strong id="maxVal" style="color: var(--danger);">-</strong> ms</div>
            <div class="card-stat"><small>ทั้งหมด</small><strong id="totalCount">-</strong> ชุด</div>
        </div>
        <div class="sla-bar" id="slaBarArea">
            <div class="card-stat"><small>< 1s</small><strong id="s1" style="color: var(--success);">-</strong></div>
            <div class="card-stat"><small>1 - 1.5s</small><strong id="s2" style="color: var(--info);">-</strong></div>
            <div class="card-stat"><small>1.5 - 2s</small><strong id="s3" style="color: var(--normal);">-</strong></div>
            <div class="card-stat"><small>2 - 3s</small><strong id="s4" style="color: var(--warning);">-</strong></div>
            <div class="card-stat"><small>> 3s</small><strong id="s5" style="color: var(--danger);">-</strong></div>
        </div>
        <div class="chart-bar">
            <canvas id="responseChart"></canvas>
        </div>
    </div>

    <div class="container">
        <table id="logTable">
            <thead>
                <tr>
                    <th class="col-idx">ชุดที่</th>
                    <th class="col-req">เวลา Request</th>
                    <th class="col-res">เวลา Response</th>
                    <th class="col-dur">Duration (ms)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let myChart = null;
    let currentData = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => processLog(event.target.result);
        reader.readAsText(file);
    });

    function cleanTimestamp(line) {
        const numbers = line.match(/\d+/g);
        if (numbers && numbers.length >= 7) {
            const [y, m, d, hh, mm, ss, ms] = numbers;
            return { dateObj: new Date(y, m-1, d, hh, mm, ss, ms), hour: hh, formatted: `${y}-${m}-${d} ${hh}:${mm}:${ss},${ms}` };
        }
        return null;
    }

    function processLog(text) {
        const lines = text.split(/\r?\n/);
        const pairs = [];
        let currentReq = null;

        lines.forEach(line => {
            const lower = line.toLowerCase();
            if (lower.includes("getitem request")) currentReq = cleanTimestamp(line);
            else if (lower.includes("getitem response") && currentReq) {
                const res = cleanTimestamp(line);
                if (res) {
                    const diff = res.dateObj - currentReq.dateObj;
                    if (diff >= 0) pairs.push({ reqTime: currentReq.formatted, resTime: res.formatted, hour: currentReq.hour, duration: diff });
                }
                currentReq = null;
            }
        });

        if (pairs.length > 0) { currentData = pairs; renderUI(pairs); document.getElementById('exportBtn').style.display = 'inline-block'; }
        else alert("ไม่พบข้อมูล");
    }

    function renderUI(data) {
        document.getElementById('mainContent').style.display = 'block';
        const durations = data.map(d => d.duration);
        const total = data.length;
        const avg = durations.reduce((a, b) => a + b, 0) / total;

        document.getElementById('avgVal').innerText = avg.toFixed(1);
        document.getElementById('minVal').innerText = Math.min(...durations).toLocaleString();
        document.getElementById('maxVal').innerText = Math.max(...durations).toLocaleString();
        document.getElementById('totalCount').innerText = total.toLocaleString();

        const limits = [1000, 1500, 2000, 3000];
        const g1 = data.filter(d => d.duration < 1000).length;
        const g2 = data.filter(d => d.duration >= 1000 && d.duration < 1500).length;
        const g3 = data.filter(d => d.duration >= 1500 && d.duration < 2000).length;
        const g4 = data.filter(d => d.duration >= 2000 && d.duration < 3000).length;
        const g5 = data.filter(d => d.duration >= 3000).length;

        const counts = [g1, g2, g3, g4, g5];
        counts.forEach((count, i) => {
            document.getElementById(`s${i+1}`).innerText = `${((count/total)*100).toFixed(1)}% (${count})`;
        });

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map((d, i) => {
            let cls = d.duration >= 3000 ? 'slow-danger' : (d.duration >= 2000 ? 'slow-warn' : '');
            return `<tr><td class="col-idx">${i+1}</td><td class="col-req">${d.reqTime}</td><td class="col-res">${d.resTime}</td><td class="col-dur ${cls}">${d.duration.toLocaleString()}</td></tr>`;
        }).join('');

        updateChart(data);
        setTimeout(recalcSticky, 100);
    }

    function recalcSticky() {
        const stickyArea = document.getElementById('stickyArea');
        const ths = document.querySelectorAll('thead th');
        if (stickyArea) ths.forEach(th => th.style.top = (stickyArea.offsetHeight + 60 - 1) + 'px');
    }

    function updateChart(data) {
        const hourly = {};
        data.forEach(d => { if (!hourly[d.hour]) hourly[d.hour] = { sum: 0, count: 0 }; hourly[d.hour].sum += d.duration; hourly[d.hour].count++; });
        const labels = Object.keys(hourly).sort().map(h => h + ":00");
        const vals = Object.keys(hourly).sort().map(h => (hourly[h].sum / hourly[h].count).toFixed(1));
        const ctx = document.getElementById('responseChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Avg Latency (ms)', data: vals, borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    async function exportToExcelPro() {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Performance Report');

        // Title
        sheet.mergeCells('A1:D2');
        const titleCell = sheet.getCell('A1');
        titleCell.value = 'GETITEM PERFORMANCE ANALYSIS';
        titleCell.font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        titleCell.alignment = { vertical: 'middle', horizontal: 'center' };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A73E8' } };

        // 1. KPI Stats Summary
        sheet.getCell('A4').value = 'OVERALL SUMMARY';
        sheet.getCell('A4').font = { bold: true, size: 12 };
        
        const stats = [
            ['Total Requests', currentData.length],
            ['Average Response', parseFloat(document.getElementById('avgVal').innerText)],
            ['Minimum Time', parseInt(document.getElementById('minVal').innerText.replace(/,/g,''))],
            ['Maximum Time', parseInt(document.getElementById('maxVal').innerText.replace(/,/g,''))]
        ];
        stats.forEach((s, i) => {
            const row = sheet.getRow(5 + i);
            row.getCell(1).value = s[0];
            row.getCell(2).value = s[1];
            row.getCell(1).font = { bold: true };
        });

        // 2. SLA BREAKDOWN (เพิ่มส่วนนี้)
        sheet.getCell('D4').value = 'SLA BREAKDOWN';
        sheet.getCell('D4').font = { bold: true, size: 12 };
        
        const total = currentData.length;
        const slaData = [
            { label: '< 1000ms', count: currentData.filter(d=>d.duration < 1000).length, color: 'FF1E8E3E' },
            { label: '1000-1500ms', count: currentData.filter(d=>d.duration >= 1000 && d.duration < 1500).length, color: 'FF03A9F4' },
            { label: '1500-2000ms', count: currentData.filter(d=>d.duration >= 1500 && d.duration < 2000).length, color: 'FF673AB7' },
            { label: '2000-3000ms', count: currentData.filter(d=>d.duration >= 2000 && d.duration < 3000).length, color: 'FFF57C00' },
            { label: '> 3000ms', count: currentData.filter(d=>d.duration >= 3000).length, color: 'FFD93025' }
        ];

        slaData.forEach((item, i) => {
            const row = sheet.getRow(5 + i);
            const labelCell = row.getCell(4);
            const valCell = row.getCell(5);
            
            labelCell.value = item.label;
            valCell.value = `${((item.count/total)*100).toFixed(1)}% (${item.count})`;
            
            labelCell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
            labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: item.color } };
            valCell.border = { bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // 3. Chart Image
        const chartImage = document.getElementById('responseChart').toDataURL('image/png');
        const imageId = workbook.addImage({ base64: chartImage, extension: 'png' });
        sheet.addImage(imageId, { tl: { col: 0, row: 11 }, ext: { width: 600, height: 220 } });

        // 4. Raw Data Header
        const startRow = 24;
        sheet.getCell(`A${startRow}`).value = 'RAW DATA DETAILS';
        sheet.getCell(`A${startRow}`).font = { bold: true, size: 12 };

        const headerRow = sheet.getRow(startRow + 1);
        headerRow.values = ['No.', 'Request Timestamp', 'Response Timestamp', 'Duration (ms)'];
        headerRow.eachCell(cell => {
            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1A73E8' } };
        });

        currentData.forEach((d, i) => {
            const row = sheet.addRow([i + 1, d.reqTime, d.resTime, d.duration]);
            if (d.duration >= 3000) row.getCell(4).font = { color: { argb: 'FFFF0000' }, bold: true };
            else if (d.duration >= 2000) row.getCell(4).font = { color: { argb: 'FFF57C00' }, bold: true };
        });

        sheet.getColumn(1).width = 10;
        sheet.getColumn(2).width = 28;
        sheet.getColumn(3).width = 28;
        sheet.getColumn(4).width = 18;
        sheet.getColumn(5).width = 20;

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `Performance_Report_${new Date().getTime()}.xlsx`);
    }

    window.addEventListener('resize', recalcSticky);
</script>

</body>
</html>
