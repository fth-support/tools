<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>สรุปจำนวนการ Upload เอกสารผ่าน API (HHT)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .card h2 {
      font-size: 18px;
      margin-top: 0;
    }
    .file-input {
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      display: inline-block;
      margin-right: 8px;
    }
    input[type="text"] {
      padding: 4px 6px;
      font-size: 13px;
    }
    button {
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }
    th.header-main {
      background: #f79646;
      color: #fff;
      font-weight: bold;
      text-align: center;
    }
    th.sub-header {
      background: #fde9d9;
      font-weight: bold;
    }
    td.number {
      text-align: right;
    }
    tr.sum-row td {
      background: #ddebf7;
      font-weight: bold;
    }
    .small {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>จำนวนการ Upload เอกสารผ่าน API (HHT)</h1>

  <div class="card">
    <h2>เลือกไฟล์ Log และระบุสาขา</h2>
    <div>
      <input class="file-input" type="file" id="logFiles" multiple accept=".txt,.log">
    </div>
    <div style="margin-top:4px;">
      <label for="storeCode">รหัสสาขา (ถ้ามี):</label>
      <input type="text" id="storeCode" placeholder="เช่น 3081">
    </div>
    <div style="margin-top:8px;">
      <button id="analyzeBtn">วิเคราะห์ log</button>
    </div>
    <div class="small">
      * เลือกได้หลายไฟล์พร้อมกัน (เช่น api_log_2025-10-20..., api_log_2025-10-21..., ฯลฯ)
    </div>
  </div>

  <div class="card">
    <h2>สรุปจำนวนการใช้งานรายวัน</h2>
    <div id="tableArea">ยังไม่ได้วิเคราะห์ไฟล์</div>
  </div>

  <script>
    // Mapping endpoint -> ชื่อคอลัมน์ภาษาไทย
    const FUNCTION_COLUMNS = [
      { key: "[POST][/api/v1/orderings/upload]",   label: "สั่งซื้อสินค้า" },
      { key: "[POST][/api/v1/receivings/upload]",  label: "รับสินค้า" },
      { key: "[POST][/api/v1/checkProducts/upload]", label: "ตรวจเช็คสินค้า" },
      { key: "[POST][/api/v1/priceTags/txt]",      label: "ป้ายราคา" },
      { key: "[POST][/api/v1/selfAudits/upload]",  label: "นับสินค้า" },
      { key: "[POST][/api/v1/outOfShelves/upload]", label: "OOS Check" }
    ];

    const analyzeBtn = document.getElementById("analyzeBtn");
    const fileInput = document.getElementById("logFiles");
    const tableArea = document.getElementById("tableArea");

    analyzeBtn.addEventListener("click", () => {
      const files = fileInput.files;
      if (!files || files.length === 0) {
        alert("กรุณาเลือกไฟล์ log ก่อน");
        return;
      }

      tableArea.textContent = "กำลังอ่านไฟล์...";

      const readers = [];
      const contents = [];

      for (let i = 0; i < files.length; i++) {
        readers.push(readFileAsText(files[i]).then(text => {
          contents.push({ name: files[i].name, text });
        }));
      }

      Promise.all(readers)
        .then(() => {
          const combinedText = contents.map(c => c.text).join("\n");
          const result = analyzeLogs(combinedText);
          renderDailyTable(result);
        })
        .catch(err => {
          console.error(err);
          tableArea.textContent = "เกิดข้อผิดพลาดในการอ่านไฟล์";
        });
    });

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsText(file, "utf-8");
      });
    }

    function extractTimeFromLine(line) {
      const match = line.match(/time="([^"]+)"/);
      return match ? match[1] : "";
    }

    // ได้ "2025-10-20" จาก "2025-10-20T22:32:04+07:00"
    function extractDateFromTimeStr(timeStr) {
      if (!timeStr) return null;
      return timeStr.substring(0, 10);
    }

    function formatDateDisplay(dateStr) {
      // จาก YYYY-MM-DD -> DD/MM/YYYY
      const [y, m, d] = dateStr.split("-");
      return `${d}/${m}/${y}`;
    }

    function initDailyObj() {
      const obj = { total: 0 };
      FUNCTION_COLUMNS.forEach(col => {
        obj[col.key] = 0;
      });
      return obj;
    }

    function analyzeLogs(text) {
      const lines = text.split(/\r?\n/);

      const daily = {};            // { "2025-10-20": { key1: count, ..., total } }
      const columnTotals = {};     // { key1: sum, ... }
      FUNCTION_COLUMNS.forEach(col => {
        columnTotals[col.key] = 0;
      });
      let grandTotal = 0;

      for (const line of lines) {
        const timeStr = extractTimeFromLine(line);
        const dateStr = extractDateFromTimeStr(timeStr);
        if (!dateStr) continue;

        for (const col of FUNCTION_COLUMNS) {
          if (line.includes(col.key)) {
            if (!daily[dateStr]) {
              daily[dateStr] = initDailyObj();
            }
            daily[dateStr][col.key]++;
            daily[dateStr].total++;

            columnTotals[col.key]++;
            grandTotal++;
          }
        }
      }

      return { daily, columnTotals, grandTotal };
    }

    function renderDailyTable(result) {
      const { daily, columnTotals, grandTotal } = result;
      const dates = Object.keys(daily).sort();

      if (dates.length === 0) {
        tableArea.textContent = "ไม่พบบรรทัด log ที่มีการเรียก API ตามที่กำหนด";
        return;
      }

      const storeCode = document.getElementById("storeCode").value.trim();

      let html = "";

      html += `<table>
        <thead>
          <tr>
            <th class="header-main" colspan="${2 + FUNCTION_COLUMNS.length}">จำนวนการ upload เอกสารผ่าน API</th>
          </tr>
          <tr>
            <th class="sub-header">วันที่</th>`;

      FUNCTION_COLUMNS.forEach(col => {
        html += `<th class="sub-header">${col.label}</th>`;
      });

      html += `<th class="sub-header">Total</th>
          </tr>
        </thead>
        <tbody>
      `;

      // แถวต่อวัน
      dates.forEach(dateStr => {
        const dayObj = daily[dateStr];
        html += `<tr>
          <td>${formatDateDisplay(dateStr)}</td>`;

        FUNCTION_COLUMNS.forEach(col => {
          html += `<td class="number">${dayObj[col.key] || 0}</td>`;
        });

        html += `<td class="number">${dayObj.total}</td>
        </tr>`;
      });

      // แถว Sum function
      html += `<tr class="sum-row">
        <td>Sum function</td>`;

      FUNCTION_COLUMNS.forEach(col => {
        html += `<td class="number">${columnTotals[col.key]}</td>`;
      });

      html += `<td class="number">${grandTotal}</td>
      </tr>`;

      html += `</tbody></table>`;

      if (storeCode) {
        html += `<div class="small" style="margin-top:4px;">สาขา ${storeCode}</div>`;
      }

      html += `<div class="small" style="margin-top:4px;">
        รวมจำนวนการ upload เอกสารผ่าน API ทั้งหมด: ${grandTotal} ครั้ง
      </div>`;

      tableArea.innerHTML = html;
    }
  </script>
</body>
</html>
