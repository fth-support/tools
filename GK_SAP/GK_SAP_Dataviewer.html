<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v25 - XML Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #8e44ad; --bg: #ecf0f1; --border: #bdc3c7; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: bold; font-size: 15px; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { 
            padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; 
            border-radius: 5px 5px 0 0; font-size: 12px; font-weight: 600; border-bottom: 3px solid transparent; 
        }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }

        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .view-section { display: none; flex: 1; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; background: white; }
        .divider { height: 8px; background: #ddd; cursor: row-resize; z-index: 50; flex-shrink: 0; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; }

        .toolbar { padding: 6px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; height: 35px; flex-shrink: 0; }
        .btn-tool { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 11px; border-radius: 3px; font-weight: 600; transition: 0.2s; }
        .btn-tool:hover { background: #eee; }
        .btn-green { background: var(--accent); color: white; border: none; }
        .btn-purple { background: var(--gk); color: white; border: none; }
        .btn-orange { background: var(--sap); color: white; border: none; }
        .btn-blue { background: #2980b9; color: white; border: none; }

        .table-wrapper { flex: 1; overflow: auto; background: white; padding: 0; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; width: 0; }
        
        th { 
            background: #f4f4f4; border: 1px solid #ddd; padding: 0; text-align: left; 
            position: sticky; top: 0; z-index: 10; font-weight: 700; color: #444; 
            white-space: nowrap; overflow: hidden; height: 28px; user-select: none;
        }
        
        .th-inner { padding: 6px; display: flex; justify-content: space-between; align-items: center; height: 100%; box-sizing: border-box; }
        td { border: 1px solid #eee; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; height: 22px; }
        tr:hover { background: #f0f8ff; }
        
        .draggable-header { cursor: grab; }
        .draggable-header:active { cursor: grabbing; }
        th.drag-over { background: #e8f8f5 !important; border: 2px dashed #27ae60 !important; color: #27ae60; }
        .mapped-badge { font-size: 9px; background: #dff0d8; color: #3c763d; padding: 1px 3px; border-radius: 3px; margin-left: 5px; font-weight: normal; }
        td.empty-cell { background-color: #fff0f0; }

        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; }
        .resizer:hover { background: var(--gk); }
        .sum-row { background: #fafafa; font-weight: bold; cursor: pointer; color: #2c3e50; }
    </style>
</head>
<body>

<nav>
    <div class="app-title">üì¶ GK Analyzer v25 - XML Importer</div>
    <div class="tabs">
        <div class="tab" onclick="switchMainTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchMainTab('promo')">2. Promo (Compare)</div>
        <div class="tab active" onclick="switchMainTab('master')">3. Master (XML Map)</div>
    </div>
</nav>

<div id="main-container">

    <div id="view-bi" class="view-section">
        <div class="toolbar">
            <b>BI Overview</b><span style="color:#666; font-size:10px; margin-left:10px;">*Displays data from Tab 2</span>
        </div>
        <div class="table-wrapper">
            <table id="biTable" style="width:100%"><thead><tr><th>Hierarchy (Store / ID)</th><th>Description</th><th>Source File</th></tr></thead><tbody id="biBody"></tbody></table>
        </div>
    </div>

    <div id="view-promo" class="view-section">
        <div class="split-container">
            <div class="panel" id="panel-promo-top" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#2980b9;">üü¶ GK XML (Promo)</b>
                    <button class="btn-tool" onclick="document.getElementById('xmlPromoInput').click()">üìÇ Load XML</button>
                    <input type="file" id="xmlPromoInput" multiple webkitdirectory style="display:none">
                    <button class="btn-tool" onclick="clearPromo('xml')">‚ùå Clear</button>
                    <button class="btn-tool btn-blue" onclick="exportTable('xmlPromoTable', 'GK_Promo_XML')">‚¨á CSV</button>
                </div>
                <div class="table-wrapper"><table id="xmlPromoTable"><thead id="xmlPromoHead"></thead><tbody id="xmlPromoBody"></tbody></table></div>
            </div>
            <div class="divider" id="div-promo"></div>
            <div class="panel" id="panel-promo-bottom" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#e67e22;">üüß SAP JSON (Promo)</b>
                    <button class="btn-tool" onclick="document.getElementById('jsonPromoInput').click()">üìÇ Load JSON</button>
                    <input type="file" id="jsonPromoInput" multiple accept=".json" style="display:none">
                    <button class="btn-tool" onclick="clearPromo('json')">‚ùå Clear</button>
                    <button class="btn-tool btn-orange" onclick="exportTable('jsonPromoTable', 'SAP_Promo_JSON')">‚¨á CSV</button>
                </div>
                <div class="table-wrapper"><table id="jsonPromoTable"><thead id="jsonPromoHead"></thead><tbody id="jsonPromoBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="view-master" class="view-section active">
        <div class="split-container">
            <div class="panel" id="panel-master-top" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#e67e22;">üüß SAP Source (Master JSON)</b>
                    <button class="btn-tool" onclick="document.getElementById('skuInput').click()">üìÇ Load Sku.json</button>
                    <input type="file" id="skuInput" multiple accept=".json" style="display:none">
                    <span style="margin-left:auto; font-size:10px; color:#666;">* Drag columns to map</span>
                </div>
                <div class="table-wrapper"><table id="sapMasterTable"><thead id="sapMasterHead"></thead><tbody id="sapMasterBody"></tbody></table></div>
            </div>
            
            <div class="divider" id="div-master"></div>

            <div class="panel" id="panel-master-bottom" style="flex:1;">
                <div class="toolbar">
                    <b style="color:#8e44ad;">üü™ GK Target (XML Template)</b>
                    <button class="btn-tool" onclick="resetMasterMapping()">‚Ü∫ Reset</button>
                    <button class="btn-tool btn-green" onclick="exportMasterXML()">‚¨á Export XML</button>
                    <span id="master-status" style="margin-left:auto; font-size:10px; color:#666;">Ready</span>
                </div>
                <div class="table-wrapper"><table id="gkMasterTable"><thead id="gkMasterHead"></thead><tbody id="gkMasterBody"></tbody></table></div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- STATE MANAGEMENT ---
    const PROMO = { xml: { data: [], columns: [] }, json: { data: [], columns: [] } };
    
    // Config for Tab 3 (XML Target)
    const MASTER = {
        sapData: [], sapKeys: [], gkData: [], currentMap: {},
        // These keys represent XML Tags. Hierarchical structures are flattened for mapping UI.
        gkColumns: [
            "BusinessUnitID", "ItemID", "MainPOSItemID", "BonText", "Description", 
            "TaxGroupID", "MerchandiseHierarchyGroupID", "RegularSalesUnitPrice", 
            "BaseUOMCode", "ClassCode", "TaxExemptCode", "ItemUsageTypeCode"
        ],
        // Default Mapping (SAP -> GK XML Tags)
        defaultMap: {
            "BusinessUnitID": "LOCNR",
            "ItemID": "MATNR",
            "MainPOSItemID": "EAN_List", // Maps to GTIN/EAN
            "BonText": "MAKTX",
            "Description": "MAKTX",
            "TaxGroupID": "CONST_A1",
            "MerchandiseHierarchyGroupID": "MATKL",
            "RegularSalesUnitPrice": "SAP_Price", // Mined Price
            "BaseUOMCode": "MEINH",
            "ClassCode": "CONST_HAWA",
            "TaxExemptCode": "CONST_00",
            "ItemUsageTypeCode": "CONST_00"
        }
    };

    MASTER.currentMap = {...MASTER.defaultMap};
    renderGKMasterHeader();
    
    // Listeners
    document.getElementById('xmlPromoInput').addEventListener('change', (e) => loadPromoFiles(e.target.files, 'xml'));
    document.getElementById('jsonPromoInput').addEventListener('change', (e) => loadPromoFiles(e.target.files, 'json'));
    document.getElementById('skuInput').addEventListener('change', (e) => loadMasterFiles(e.target.files));

    function switchMainTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // ==========================================
    // TAB 3: MASTER DATA LOGIC
    // ==========================================
    async function loadMasterFiles(files) {
        if (!files.length) return;
        MASTER.sapData = [];
        let allKeys = new Set();

        for (let file of Array.from(files)) {
            const text = await file.text();
            try {
                const json = JSON.parse(text);
                let items = json.AssortmentSend_MT?.AssortmentList || [json];
                if (!Array.isArray(items)) items = [items];

                items.forEach(item => {
                    let flat = {};
                    flattenJSON_Master(item, flat, "");
                    
                    // Price Mining
                    let price = "";
                    let baseUOM = null;
                    if (item.UOM && Array.isArray(item.UOM)) {
                        baseUOM = item.UOM.find(u => u.MEINH === 'EA' || u.MEINH === 'PCE') || item.UOM[0];
                        if (baseUOM) {
                            flat['MEINH'] = baseUOM.MEINH || "";
                            flat['EAN_List'] = baseUOM.EAN11 || (baseUOM.EAN ? baseUOM.EAN[0]?.EAN11 : "") || "";
                            if (baseUOM.CONDITION && Array.isArray(baseUOM.CONDITION)) {
                                let cond = baseUOM.CONDITION.find(c => c.KSCHL === 'VKP1') || baseUOM.CONDITION[0];
                                if (cond && cond.CONDITION_VALUE && cond.CONDITION_VALUE.length > 0) {
                                    price = cond.CONDITION_VALUE[0].KWERT || "0";
                                }
                            }
                        }
                    }
                    flat['SAP_Price'] = price;
                    flat['MAKTX'] = item.MATTEXT?.find(t => t.SPRAS === 'E')?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
                    if(flat['MATNR']) flat['MATNR'] = flat['MATNR'].replace(/^0+/, '');
                    
                    MASTER.sapData.push(flat);
                });
            } catch(e) { console.error(e); }
        }
        MASTER.sapData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));
        MASTER.sapKeys = Array.from(allKeys).sort();
        renderSapMasterTable(); applyMasterMapping();
    }

    function flattenJSON_Master(obj, res, prefix) {
        for (let k in obj) {
            let v = obj[k];
            let key = prefix ? prefix + "." + k : k;
            if (v === null) continue;
            if (typeof v === 'object' && !Array.isArray(v)) flattenJSON_Master(v, res, key);
            else if (Array.isArray(v)) res[key] = JSON.stringify(v);
            else res[key] = v;
        }
    }

    function renderSapMasterTable() {
        const thead = document.getElementById('sapMasterHead');
        const tbody = document.getElementById('sapMasterBody');
        thead.innerHTML = `<tr>${MASTER.sapKeys.map(k => `<th draggable="true" ondragstart="dragStart(event, '${k}')" class="draggable-header" style="width:120px;"><div class="th-inner">${k}</div></th>`).join('')}</tr>`;
        tbody.innerHTML = MASTER.sapData.slice(0, 50).map(r => `<tr>${MASTER.sapKeys.map(k => `<td>${r[k]||''}</td>`).join('')}</tr>`).join('');
    }

    function renderGKMasterHeader() {
        const thead = document.getElementById('gkMasterHead');
        thead.innerHTML = `<tr>${MASTER.gkColumns.map(col => {
            let map = MASTER.currentMap[col];
            let badge = map && !map.startsWith("CONST_") ? `<span class="mapped-badge">‚Üê ${map}</span>` : '';
            return `<th ondragover="allowDrop(event)" ondrop="drop(event, '${col}')" style="width:120px;"><div class="th-inner">${col} ${badge}</div></th>`;
        }).join('')}</tr>`;
    }

    function applyMasterMapping() {
        MASTER.gkData = MASTER.sapData.map(sapRow => {
            let gkRow = {};
            MASTER.gkColumns.forEach(col => {
                let key = MASTER.currentMap[col];
                gkRow[col] = !key ? "" : (key.startsWith("CONST_") ? key.replace("CONST_", "") : sapRow[key] || "");
            });
            return gkRow;
        });
        renderGKMasterHeader();
        document.getElementById('gkMasterBody').innerHTML = MASTER.gkData.slice(0, 50).map(r => `<tr>${MASTER.gkColumns.map(c => `<td class="${!r[c]?'empty-cell':''}">${r[c]||''}</td>`).join('')}</tr>`).join('');
        document.getElementById('master-status').textContent = `${MASTER.gkData.length} items ready`;
    }

    // --- XML EXPORT LOGIC ---
    function exportMasterXML() {
        if(MASTER.gkData.length === 0) return alert("No data");
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        xml += `<ItemList xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" NumberOfItems="${MASTER.gkData.length}">\n`;
        
        MASTER.gkData.forEach(row => {
            xml += `\t<Item ChangeType="DIRECT">\n`;
            
            // Construct Hierarchical XML from Flat Map
            if(row.BusinessUnitID) {
                xml += `\t\t<BusinessUnitAssignment>\n`;
                xml += `\t\t\t<BusinessUnitID>${row.BusinessUnitID}</BusinessUnitID>\n`;
                xml += `\t\t</BusinessUnitAssignment>\n`;
            }
            if(row.ItemID) xml += `\t\t<ItemID>${row.ItemID}</ItemID>\n`;
            if(row.MainPOSItemID) xml += `\t\t<MainPOSItemID>${row.MainPOSItemID}</MainPOSItemID>\n`; // EAN
            if(row.BonText) xml += `\t\t<BonText>${escapeXml(row.BonText)}</BonText>\n`;
            if(row.Description) xml += `\t\t<Description>${escapeXml(row.Description)}</Description>\n`;
            if(row.TaxGroupID) xml += `\t\t<TaxGroupID>${row.TaxGroupID}</TaxGroupID>\n`;
            if(row.BaseUOMCode) xml += `\t\t<BaseUOMCode>${row.BaseUOMCode}</BaseUOMCode>\n`;
            if(row.ClassCode) xml += `\t\t<ClassCode>${row.ClassCode}</ClassCode>\n`;
            if(row.TaxExemptCode) xml += `\t\t<TaxExemptCode>${row.TaxExemptCode}</TaxExemptCode>\n`;
            if(row.ItemUsageTypeCode) xml += `\t\t<ItemUsageTypeCode>${row.ItemUsageTypeCode}</ItemUsageTypeCode>\n`;
            
            if(row.MerchandiseHierarchyGroupID) {
                xml += `\t\t<MerchandiseHierarchyGroupAssignment>\n`;
                xml += `\t\t\t<MerchandiseHierarchyGroupID>${row.MerchandiseHierarchyGroupID}</MerchandiseHierarchyGroupID>\n`;
                xml += `\t\t</MerchandiseHierarchyGroupAssignment>\n`;
            }
            
            if(row.RegularSalesUnitPrice && row.RegularSalesUnitPrice !== "0") {
                xml += `\t\t<RegularSalesUnitPrice>${row.RegularSalesUnitPrice}</RegularSalesUnitPrice>\n`;
            }
            
            xml += `\t</Item>\n`;
        });
        
        xml += `</ItemList>`;
        downloadFile(xml, "ItemMasterData_Import.xml", "text/xml");
    }

    function escapeXml(unsafe) {
        return unsafe.replace(/[<>&'"]/g, function (c) {
            switch (c) {
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '&': return '&amp;';
                case '\'': return '&apos;';
                case '"': return '&quot;';
            }
        });
    }

    // Drag & Drop
    function dragStart(e, k) { e.dataTransfer.setData("text", k); }
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function drop(e, col) {
        e.preventDefault(); e.currentTarget.classList.remove('drag-over');
        MASTER.currentMap[col] = e.dataTransfer.getData("text");
        applyMasterMapping();
    }
    function resetMasterMapping() { MASTER.currentMap = {...MASTER.defaultMap}; applyMasterMapping(); }

    // ==========================================
    // TAB 1 & 2 LOGIC (Unchanged)
    // ==========================================
    async function loadPromoFiles(files, type) {
        if (!files.length) return;
        PROMO[type].data = [];
        let orderedKeys = new Set(); 
        for (let file of Array.from(files)) {
            const text = await file.text();
            let row = { "FileName": file.name };
            if (type === 'xml') {
                if (!file.name.toLowerCase().endsWith('.xml')) continue;
                const xml = new DOMParser().parseFromString(text, "text/xml");
                row._id = xml.querySelector("PromotionID")?.textContent || "N/A";
                row._desc = xml.querySelector("Description")?.textContent || "";
                row._stores = Array.from(xml.querySelectorAll("BusinessUnitID")).map(b => b.textContent);
                flattenDocOrder(xml.documentElement, row, "");
                PROMO[type].data.push(row);
            } else {
                if (!file.name.toLowerCase().endsWith('.json')) continue;
                try {
                    const json = JSON.parse(text);
                    let items = json.RetailIncentiveERPStoreOfferReplicationBulkRequest_V1?.RetailIncentiveERPStoreOfferReplicationRequestMessage_V1 || [json];
                    if(!Array.isArray(items)) items = [items];
                    items.forEach(item => {
                        let subRow = { "FileName": file.name };
                        subRow._id = item.RetailIncentive?.RetailEventID || "N/A";
                        subRow._desc = item.RetailIncentive?.Description?.[0]?.Description?.[0]?.["$"] || "";
                        let stores = [];
                        (item.RetailIncentive?.SalesArea?.StoreGroup || []).forEach(sg => { if(sg.Store) sg.Store.forEach(s => stores.push(s.InternalID)); });
                        subRow._stores = stores;
                        flattenDocOrderJSON(item, subRow, "");
                        PROMO[type].data.push(subRow);
                    });
                } catch(e) { console.error(e); }
            }
        }
        PROMO[type].data.forEach(r => Object.keys(r).forEach(k => { if(!k.startsWith("_")) orderedKeys.add(k); }));
        PROMO[type].columns = Array.from(orderedKeys);
        renderPromoTable(type); updateBI();
    }
    
    function flattenDocOrder(node, res, prefix) {
        if (node.children.length === 0) {
            let val = node.textContent.trim();
            if (val) res[node.nodeName] = res[node.nodeName] ? res[node.nodeName] + "," + val : val;
        } else Array.from(node.children).forEach(child => flattenDocOrder(child, res, prefix));
    }
    function flattenDocOrderJSON(obj, res, prefix) {
        for (let k in obj) {
            let v = obj[k];
            let newKey = prefix ? (k === "$" ? prefix + ".$" : prefix + "." + k) : k;
            if (v === null) continue;
            if (Array.isArray(v)) {
                if (v.length > 0 && typeof v[0] === 'object') {
                    let subKeys = new Set();
                    v.forEach(item => flattenKeys(item, "", subKeys));
                    subKeys.forEach(sk => {
                        let fullSubKey = newKey + (sk.startsWith(".") ? "" : ".") + sk;
                        let values = v.map(item => getDeepValue(item, sk) || "").filter(val => val !== "").join(",");
                        if(values) res[fullSubKey] = values;
                    });
                } else res[newKey] = v.join(",");
            } else if (typeof v === 'object') flattenDocOrderJSON(v, res, newKey);
            else res[newKey] = v;
        }
    }
    function flattenKeys(obj, prefix, set) { for(let k in obj) { let p = prefix ? (k==="$" ? prefix+".$" : prefix+"."+k) : k; if(typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) flattenKeys(obj[k], p, set); else set.add(p); } }
    function getDeepValue(obj, path) { return path.split('.').reduce((o, i) => (i==="$" ? (o && o["$"]) : (o ? o[i] : undefined)), obj); }

    function renderPromoTable(type) {
        const thead = document.getElementById(`${type}PromoHead`);
        const tbody = document.getElementById(`${type}PromoBody`);
        thead.innerHTML = `<tr>${PROMO[type].columns.map(k => `<th style="width:120px;"><div class="th-inner">${k}</div><div class="resizer" onmousedown="initResize(event)"></div></th>`).join('')}</tr>`;
        tbody.innerHTML = PROMO[type].data.map(r => `<tr>${PROMO[type].columns.map(k => `<td title="${r[k]||''}">${r[k]||''}</td>`).join('')}</tr>`).join('');
    }
    function clearPromo(type) { PROMO[type].data = []; PROMO[type].columns = []; renderPromoTable(type); updateBI(); }
    function updateBI() {
        const tbody = document.getElementById('biBody'); tbody.innerHTML = ""; let map = {};
        const allData = [...PROMO.xml.data.map(d=>({...d, src:'XML'})), ...PROMO.json.data.map(d=>({...d, src:'JSON'}))];
        allData.forEach(d => { let stores = d._stores || []; if(stores.length === 0) stores = ['No Store']; stores.forEach(s => { if(!map[s]) map[s]=[]; map[s].push(d); }); });
        Object.keys(map).sort().forEach(store => {
            let tr = document.createElement('tr'); tr.className = 'sum-row'; tr.innerHTML = `<td colspan="3">‚ñ∂ Store: ${store} (${map[store].length})</td>`;
            tr.onclick = function() { let next = this.nextSibling; while(next && next.classList.contains('sum-child')) { next.style.display = next.style.display === 'none' ? 'table-row' : 'none'; next = next.nextSibling; } };
            tbody.appendChild(tr);
            map[store].forEach(d => { let cr = document.createElement('tr'); cr.className = 'sum-child'; cr.style.display = 'none'; cr.innerHTML = `<td>${d._id}</td><td>${d._desc.substring(0,50)}</td><td>${d.src}: ${d.FileName}</td>`; tbody.appendChild(cr); });
        });
    }

    // UTILS
    function initResize(e) { e.preventDefault(); e.stopPropagation(); const th = e.target.parentElement; const startX = e.pageX; const startW = th.offsetWidth; const mm = (ev) => th.style.width = Math.max(50, startW + (ev.pageX - startX)) + "px"; const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); }; document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); }
    function exportTable(tableId, fname) { const wb = XLSX.utils.table_to_book(document.getElementById(tableId)); XLSX.writeFile(wb, fname + ".xlsx"); }
    function downloadFile(content, fileName, mimeType) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], {type: mimeType})); a.download = fileName; a.click(); }
    ['div-promo', 'div-master'].forEach(id => { document.getElementById(id).addEventListener('mousedown', (e) => { e.preventDefault(); const panelId = id === 'div-promo' ? 'panel-promo-top' : 'panel-master-top'; const startY = e.clientY; const startH = document.getElementById(panelId).offsetHeight; const mm = (ev) => document.getElementById(panelId).style.flex = `0 0 ${Math.max(50, startH + (ev.clientY - startY))}px`; const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); }; document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); }); });
</script>
</body>
</html>
