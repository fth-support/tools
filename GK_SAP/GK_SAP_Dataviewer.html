<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v22 - Interactive Mapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #2980b9; --bg: #ecf0f1; --border: #bdc3c7; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        
        /* Navigation */
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: bold; font-size: 15px; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { 
            padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; 
            border-radius: 5px 5px 0 0; font-size: 12px; font-weight: 600; border-bottom: 3px solid transparent; 
        }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }

        /* Main Content */
        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .view-section { display: none; flex: 1; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        /* Split View Styles */
        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; background: white; }
        .divider { height: 8px; background: #ddd; cursor: row-resize; z-index: 50; flex-shrink: 0; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; }

        /* Toolbar */
        .toolbar { padding: 6px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; height: 35px; flex-shrink: 0; }
        .btn-tool { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 11px; border-radius: 3px; font-weight: 600; transition: 0.2s; }
        .btn-tool:hover { background: #eee; }
        .btn-green { background: var(--accent); color: white; border: none; }
        .btn-orange { background: var(--sap); color: white; border: none; }

        /* Table Styles */
        .table-wrapper { flex: 1; overflow: auto; background: white; padding: 0; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; width: 0; }
        
        th { 
            background: #f4f4f4; border: 1px solid #ddd; padding: 0; text-align: left; 
            position: sticky; top: 0; z-index: 10; font-weight: 700; color: #444; 
            white-space: nowrap; overflow: hidden; height: 28px; user-select: none;
        }
        
        .th-inner { padding: 6px; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
        .th-inner:active { cursor: grabbing; }

        /* Drop Zone Highlight */
        th.drag-over { background: #e8f8f5 !important; border: 2px dashed #27ae60 !important; color: #27ae60; }

        td { border: 1px solid #eee; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; height: 22px; }
        tr:hover { background: #f0f8ff; }
        
        /* Highlight Empty Cells in Target */
        td.empty-cell { background-color: #fff0f0; }

        /* Mapped Indicator */
        .mapped-badge { font-size: 9px; background: #dff0d8; color: #3c763d; padding: 1px 3px; border-radius: 3px; margin-left: 5px; font-weight: normal; }

        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; }
        .resizer:hover { background: var(--gk); }
    </style>
</head>
<body>

<nav>
    <div class="app-title">üì¶ GK Analyzer v22 - Mapper</div>
    <div class="tabs">
        <div class="tab" onclick="switchMainTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchMainTab('mapping')">2. Promotion Mapping</div>
        <div class="tab active" onclick="switchMainTab('master')">3. Master Data Mapper</div>
    </div>
</nav>

<div id="main-container">

    <div id="view-bi" class="view-section"><div style="padding:20px;">Use Tab 3 for Master Data Mapping</div></div>
    <div id="view-mapping" class="view-section"><div style="padding:20px;">Use Tab 3 for Master Data Mapping</div></div>

    <div id="view-master" class="view-section active">
        <div class="split-container">
            
            <div class="panel" id="panel-top" style="flex: 1;">
                <div class="toolbar">
                    <b style="color:#e67e22;">üüß SAP Source (JSON)</b>
                    <button class="btn-tool" onclick="document.getElementById('skuInput').click()">üìÇ Load Sku.json</button>
                    <input type="file" id="skuInput" multiple accept=".json" style="display:none">
                    <span style="margin-left:auto; font-size:10px; color:#666;">* ‡∏•‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </div>
                <div class="table-wrapper">
                    <table id="sapTable"><thead id="sapHead"></thead><tbody id="sapBody"></tbody></table>
                </div>
            </div>

            <div class="divider" id="drag-divider"></div>

            <div class="panel" id="panel-bottom" style="flex: 1;">
                <div class="toolbar">
                    <b style="color:#2980b9;">üü¶ GK Target (CSV Template)</b>
                    <button class="btn-tool" onclick="resetMapping()">‚Ü∫ Reset Default</button>
                    <button class="btn-tool btn-green" onclick="exportCSV()">‚¨á Export CSV (;)</button>
                    <span id="target-status" style="margin-left:auto; font-size:10px; color:#666;">Ready</span>
                </div>
                <div class="table-wrapper">
                    <table id="gkTable"><thead id="gkHead"></thead><tbody id="gkBody"></tbody></table>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const GK_COLUMNS = [
        "BusinessUnitId", "ItemId", "GTIN", "UomCode", "Name", "Description", 
        "TaxGroupId", "MerchandiseHierarchyGroupId", "Price", 
        "ShelfNumber", "ShelfLocation", "ActionPrice", 
        "ActionPriceEffectiveDate", "ActionPriceExpirationDate", 
        "SinglePiecesPerPackage", "PackagePiecesPerBox", 
        "PackageNetContent", "PackageBasicPriceContent"
    ];

    // Default Mapping Logic (SAP Key -> GK Column)
    const DEFAULT_MAPPING = {
        "BusinessUnitId": "LOCNR",
        "ItemId": "MATNR",
        "GTIN": "EAN_List",     // Custom logic key
        "UomCode": "MEINH",     // Custom logic key
        "Name": "MAKTX",
        "Description": "MAKTX",
        "MerchandiseHierarchyGroupId": "MATKL",
        "TaxGroupId": "CONST_1", // Constant value
        "Price": "CONST_0",
        "SinglePiecesPerPackage": "CONST_1",
        "PackagePiecesPerBox": "CONST_1",
        "PackageNetContent": "CONST_1",
        "PackageBasicPriceContent": "CONST_1"
    };

    let APP = {
        sapData: [],    // Flattened SAP Data
        sapKeys: [],    // SAP Column Headers
        currentMap: {...DEFAULT_MAPPING}, // Active Mapping
        gkData: []      // Generated GK Data
    };

    // --- INITIALIZATION ---
    renderGKHeader(); // Show template headers immediately
    document.getElementById('skuInput').addEventListener('change', (e) => loadSAP(e.target.files));

    function switchMainTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- 1. LOAD SAP DATA ---
    async function loadSAP(files) {
        if (!files.length) return;
        APP.sapData = [];
        let allKeys = new Set();

        for (let file of Array.from(files)) {
            const text = await file.text();
            try {
                const json = JSON.parse(text);
                let items = json.AssortmentSend_MT?.AssortmentList || [json];
                if (!Array.isArray(items)) items = [items];

                items.forEach(item => {
                    let flat = {};
                    // Flatten JSON
                    flattenJSON(item, flat, "");
                    
                    // Add Custom Helpers for easier mapping
                    // Extract first UOM info to top level
                    if (item.UOM && item.UOM.length > 0) {
                        let base = item.UOM.find(u => u.MEINH === 'EA' || u.MEINH === 'PCE') || item.UOM[0];
                        flat['MEINH'] = base.MEINH || "";
                        flat['EAN_List'] = base.EAN11 || (base.EAN ? base.EAN[0]?.EAN11 : "") || "";
                    }
                    // Extract English Description
                    flat['MAKTX'] = item.MATTEXT?.find(t => t.SPRAS === 'E')?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
                    // Clean MATNR
                    if(flat['MATNR']) flat['MATNR'] = flat['MATNR'].replace(/^0+/, '');

                    APP.sapData.push(flat);
                });
            } catch(e) { console.error(e); }
        }

        // Collect Columns
        APP.sapData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));
        APP.sapKeys = Array.from(allKeys).sort();

        renderSAPTable();
        applyMapping(); // Generate GK Data
    }

    function flattenJSON(obj, res, prefix) {
        for (let k in obj) {
            let v = obj[k];
            let key = prefix ? prefix + "." + k : k;
            if (v === null) continue;
            if (typeof v === 'object' && !Array.isArray(v)) flattenJSON(v, res, key);
            else if (Array.isArray(v)) res[key] = JSON.stringify(v); // Keep array as string for reference
            else res[key] = v;
        }
    }

    // --- 2. RENDER TABLES ---
    function renderSAPTable() {
        const thead = document.getElementById('sapHead');
        const tbody = document.getElementById('sapBody');
        
        thead.innerHTML = `<tr>${APP.sapKeys.map(k => `
            <th draggable="true" ondragstart="dragStart(event, '${k}')" style="width:120px;">
                <div class="th-inner"><span>${k}</span> <span style="font-size:10px">‚ãÆ</span></div>
            </th>`).join('')}</tr>`;
            
        // Show first 50 rows for performance
        const displayData = APP.sapData.slice(0, 100);
        tbody.innerHTML = displayData.map(r => `<tr>${APP.sapKeys.map(k => `<td>${r[k]||''}</td>`).join('')}</tr>`).join('');
    }

    function renderGKHeader() {
        const thead = document.getElementById('gkHead');
        thead.innerHTML = `<tr>${GK_COLUMNS.map(col => {
            let mappedSource = APP.currentMap[col];
            let badge = mappedSource ? `<span class="mapped-badge">‚Üê ${mappedSource}</span>` : '';
            return `
            <th ondragover="allowDrop(event)" ondrop="drop(event, '${col}')" style="width:120px;">
                <div class="th-inner">
                    <span>${col} ${badge}</span>
                </div>
            </th>`;
        }).join('')}</tr>`;
    }

    function renderGKBody() {
        const tbody = document.getElementById('gkBody');
        // Generate rows based on mapping
        tbody.innerHTML = APP.gkData.slice(0, 100).map(row => `
            <tr>${GK_COLUMNS.map(col => {
                let val = row[col] || "";
                let isEmpty = val === "" || val === undefined;
                return `<td class="${isEmpty ? 'empty-cell' : ''}">${val}</td>`;
            }).join('')}</tr>
        `).join('');
        document.getElementById('target-status').textContent = `Generated ${APP.gkData.length} rows`;
    }

    // --- 3. MAPPING ENGINE ---
    function applyMapping() {
        APP.gkData = APP.sapData.map(sapRow => {
            let gkRow = {};
            GK_COLUMNS.forEach(col => {
                let sourceKey = APP.currentMap[col];
                if (!sourceKey) {
                    gkRow[col] = "";
                } else if (sourceKey.startsWith("CONST_")) {
                    gkRow[col] = sourceKey.replace("CONST_", "");
                } else {
                    gkRow[col] = sapRow[sourceKey] || "";
                }
            });
            return gkRow;
        });
        renderGKHeader(); // Update badges
        renderGKBody();
    }

    // --- 4. DRAG & DROP LOGIC ---
    function dragStart(e, sapKey) {
        e.dataTransfer.setData("text/plain", sapKey);
        e.dataTransfer.effectAllowed = "copy";
    }

    function allowDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function drop(e, gkCol) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const sapKey = e.dataTransfer.getData("text/plain");
        
        // Update Mapping
        APP.currentMap[gkCol] = sapKey;
        
        // Re-calculate
        applyMapping();
    }

    function resetMapping() {
        APP.currentMap = {...DEFAULT_MAPPING};
        applyMapping();
    }

    // --- 5. EXPORT ---
    function exportCSV() {
        if(APP.gkData.length === 0) return alert("No data to export");
        let csv = GK_COLUMNS.join(";") + "\n";
        APP.gkData.forEach(row => {
            csv += GK_COLUMNS.map(c => row[c] || "").join(";") + "\n";
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "GK_Master_Import.csv";
        link.click();
    }

    // --- SPLITTER ---
    const divider = document.getElementById('drag-divider');
    divider.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const startY = e.clientY;
        const startH = document.getElementById('panel-top').offsetHeight;
        const mm = (ev) => {
            let newH = startH + (ev.clientY - startY);
            if(newH > 50 && newH < document.body.offsetHeight-100) document.getElementById('panel-top').style.flex = `0 0 ${newH}px`;
        };
        const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
        document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    });
</script>
</body>
</html>
