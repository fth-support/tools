<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v31 - Haribo Mirror Exact</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #8e44ad; --bg: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; border-radius: 5px 5px 0 0; font-size: 12px; font-weight: bold; }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }
        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        .divider { height: 8px; background: #ddd; cursor: row-resize; z-index: 50; flex-shrink: 0; }
        .toolbar { padding: 8px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        .btn-green { background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .table-wrapper { flex: 1; overflow: auto; background: white; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; width: 0; }
        th { background: #f4f4f4; border: 1px solid #ddd; padding: 0; text-align: left; position: sticky; top: 0; z-index: 10; font-weight: 700; height: 35px; }
        .th-inner { padding: 8px; display: flex; align-items: center; justify-content: space-between; }
        td { border: 1px solid #eee; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 25px; }
        .draggable-header { cursor: grab; background: #fffbe6; }
        th.drag-over { background: #e8f8f5 !important; border: 2px dashed #27ae60 !important; }
        .mapped-badge { font-size: 9px; background: #dff0d8; color: #3c763d; padding: 1px 3px; border-radius: 3px; margin-left: 5px; font-weight: normal; }
        td.empty-cell { background-color: #fff0f0; }
        .view-section { display: none; flex: 1; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }
    </style>
</head>
<body>

<nav>
    <div style="font-weight:bold;">üì¶ GK Analyzer v31 (Haribo Exact)</div>
    <div class="tabs">
        <div class="tab" onclick="switchMainTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchMainTab('promo')">2. Promo Compare</div>
        <div class="tab active" onclick="switchMainTab('master')">3. Master (Final Mirror)</div>
    </div>
</nav>

<div id="main-container">
    <div id="view-bi" class="view-section"></div>
    <div id="view-promo" class="view-section"></div>

    <div id="view-master" class="view-section active">
        <div class="split-container">
            <div class="panel" id="p-top">
                <div class="toolbar">
                    <b style="color:var(--sap);">üüß SAP Source (Sku.json)</b>
                    <input type="file" id="skuInput" accept=".json" style="font-size:11px;">
                    <span style="font-size:10px; color:#666; margin-left:auto;">* Drag columns from here</span>
                </div>
                <div class="table-wrapper"><table id="sapTable"><thead id="sapHead"></thead><tbody id="sapBody"></tbody></table></div>
            </div>

            <div class="divider" id="div-m"></div>

            <div class="panel" id="p-bottom">
                <div class="toolbar">
                    <b style="color:var(--gk);">üü™ GK Mirror Target (Haribo Exact Structure)</b>
                    <button class="btn-green" onclick="exportMasterXML()">‚¨á Export 100% Mirror XML</button>
                    <button class="btn-tool" onclick="resetMapping()" style="margin-left:5px; font-size:10px;">‚Ü∫ Reset</button>
                </div>
                <div class="table-wrapper"><table id="gkTable"><thead id="gkHead"></thead><tbody id="gkBody"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
    // FULL SCHEMA: ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á XML ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Haribo
    const GK_SCHEMA = [
        "BusinessUnitID", "ItemID", "BonText", "Description", "TaxGroupID", "UpdateStockFlag", 
        "BaseUOMCode", "MinimumShelfLifeDayCount", "ClassCode", "TaxExemptCode", "WarrantyPeriod", 
        "LabelType", "ItemUsageTypeCode", "GlobalLifeDayCount", "ShelfLifeDayCountPercent", 
        "PhoneCardLoadingTypeCode", "DefaultReceivingLocation", "CostItemFlag", 
        "MerchandisePlanningTypeCode", "MainSupplierID", "BaseUOMConsumerPackageNetContent", 
        "BaseUOMConsumerPackageContentsUOMCode", "BaseUOMConsumerPackageBasePriceContent", 
        "BaseUOMConsumerPackageBasePriceContentsUOMCode", "DistributingWarehouseID", "AssortmentID", 
        "ThirdPartyAssortmentID", "TransportAssociationID", "DefaultSellingUOMCode",
        // UOM Level
        "UOMCode", "ConversionNumerator", "ConversionDenominator", "ConsumerPackageNetWeight", 
        "ConsumerPackageWeightUOMCode", "ConsumerPackageSizeUOMCode", "ConsumerPackageBasePriceUOMCode", 
        "POSDepartmentID", "MainPOSItemID", "StatusCode", "MaximumStockQuantity", "MinimumStockQuantity", 
        "ListingEffectiveDate", "ListingExpirationDate", "MainMerchandiseHierarchyGroupID", 
        // Price & EAN
        "Price", "EffectiveDate", "ExpirationDate", "PriceTypeCode", "PosItemID", "PosIdentityTypeCode", 
        "MerchandiseHierarchyGroupID"
    ];

    const DEFAULT_MAP = {
        "BusinessUnitID": "LOCNR", 
        "ItemID": "MATNR", 
        "BonText": "MAKTX", 
        "Description": "MAKTX",
        "TaxGroupID": "CONST_A1", 
        "UpdateStockFlag": "CONST_true", 
        "BaseUOMCode": "MEINH", 
        "MinimumShelfLifeDayCount": "CONST_0",
        "ClassCode": "CONST_HAWA", 
        "TaxExemptCode": "CONST_00",
        "LabelType": "CONST_HAWA",
        "ItemUsageTypeCode": "CONST_00",
        "ShelfLifeDayCountPercent": "CONST_0",
        "CostItemFlag": "CONST_true",
        "MerchandisePlanningTypeCode": "CONST_RP",
        "BaseUOMConsumerPackageNetContent": "CONST_1",
        "BaseUOMConsumerPackageContentsUOMCode": "MEINH",
        "BaseUOMConsumerPackageBasePriceContent": "CONST_1",
        "BaseUOMConsumerPackageBasePriceContentsUOMCode": "MEINH",
        "DefaultSellingUOMCode": "MEINH",
        
        // UOM Level
        "UOMCode": "MEINH", 
        "ConversionNumerator": "CONST_1",
        "ConversionDenominator": "CONST_1",
        "ConsumerPackageNetWeight": "CONST_1",
        "ConsumerPackageWeightUOMCode": "CONST_ST",
        "ConsumerPackageSizeUOMCode": "MEINH",
        "ConsumerPackageBasePriceUOMCode": "MEINH",
        "POSDepartmentID": "MATKL", // Often mapped to group
        "MainPOSItemID": "EAN_List",
        "StatusCode": "CONST_F",
        "MaximumStockQuantity": "CONST_999",
        "MinimumStockQuantity": "CONST_5",
        "ListingEffectiveDate": "CONST_20080106", // Format YYYYMMDD
        "ListingExpirationDate": "CONST_99991231",
        "MainMerchandiseHierarchyGroupID": "MATKL",
        
        // Price & EAN
        "Price": "SAP_Price", 
        "EffectiveDate": "CONST_20090101",
        "ExpirationDate": "CONST_20281212",
        "PriceTypeCode": "CONST_01",
        "PosItemID": "EAN_List",
        "PosIdentityTypeCode": "CONST_10",
        "MerchandiseHierarchyGroupID": "MATKL"
    };

    let APP = { sapData: [], sapKeys: [], currentMap: {...DEFAULT_MAP}, gkData: [] };

    document.getElementById('skuInput').addEventListener('change', async (e) => {
        if(!e.target.files.length) return;
        const json = JSON.parse(await e.target.files[0].text());
        
        // Handle different JSON structures from SAP (Single or List)
        let list = json.AssortmentSend_MT?.AssortmentList || (Array.isArray(json) ? json : [json]);
        if(!Array.isArray(list)) list = [list];

        APP.sapData = list.map(item => {
            let flat = {};
            flattenJSON(item, flat, "");
            
            // Helper logic for SAP specific extractions
            let u = item.UOM?.find(x => x.MEINH === 'EA' || x.MEINH === 'PCE') || item.UOM?.[0];
            
            // Extract Price (Condition VKP1)
            let priceObj = u?.CONDITION?.find(c => c.KSCHL === 'VKP1') || u?.CONDITION?.[0];
            flat['SAP_Price'] = priceObj?.CONDITION_VALUE?.[0]?.KWERT || "0";
            
            // Extract EAN
            flat['EAN_List'] = u?.EAN11 || u?.EAN?.[0]?.EAN11 || "";
            
            // Extract UOM
            flat['MEINH'] = u?.MEINH || "PCE";
            
            // Extract Description (EN)
            flat['MAKTX'] = item.MATTEXT?.find(t => t.SPRAS === 'E')?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
            
            // Clean ItemID (Remove leading zeros)
            if(flat['MATNR']) flat['MATNR'] = flat['MATNR'].replace(/^0+/, '');
            
            return flat;
        });

        let keys = new Set();
        APP.sapData.forEach(d => Object.keys(d).forEach(k => keys.add(k)));
        APP.sapKeys = Array.from(keys).sort();

        renderSapTable();
        applyMapping();
    });

    function flattenJSON(obj, res, prefix) {
        for (let k in obj) {
            let key = prefix ? prefix + "." + k : k;
            if (obj[k] !== null && typeof obj[k] === 'object' && !Array.isArray(obj[k])) flattenJSON(obj[k], res, key);
            else if (Array.isArray(obj[k])) res[key] = JSON.stringify(obj[k]);
            else res[key] = obj[k];
        }
    }

    function renderSapTable() {
        document.getElementById('sapHead').innerHTML = `<tr>${APP.sapKeys.map(k => `
            <th draggable="true" ondragstart="event.dataTransfer.setData('text', '${k}')" class="draggable-header" style="width:150px;">
                <div class="th-inner">${k} ‚†ø</div>
            </th>`).join('')}</tr>`;
        document.getElementById('sapBody').innerHTML = APP.sapData.slice(0, 50).map(r => `<tr>${APP.sapKeys.map(k => `<td>${r[k]||''}</td>`).join('')}</tr>`).join('');
    }

    function renderGkHeader() {
        document.getElementById('gkHead').innerHTML = `<tr>${GK_SCHEMA.map(col => {
            let map = APP.currentMap[col];
            let badge = map && !map.startsWith("CONST_") ? `<span class="mapped-badge">‚Üê ${map}</span>` : '';
            return `<th ondragover="event.preventDefault(); this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleDrop(event, '${col}')" style="width:150px;">
                <div class="th-inner">${col} ${badge}</div>
            </th>`;
        }).join('')}</tr>`;
    }

    function applyMapping() {
        APP.gkData = APP.sapData.map(sapRow => {
            let row = {};
            GK_SCHEMA.forEach(col => {
                let k = APP.currentMap[col];
                row[col] = !k ? "" : (k.startsWith("CONST_") ? k.replace("CONST_", "") : sapRow[k] || "");
            });
            return row;
        });
        renderGkHeader();
        document.getElementById('gkBody').innerHTML = APP.gkData.slice(0, 50).map(r => `<tr>${GK_SCHEMA.map(c => `<td class="${!r[c]?'empty-cell':''}">${r[c]||''}</td>`).join('')}</tr>`).join('');
    }

    function handleDrop(e, col) {
        e.preventDefault(); e.target.closest('th').classList.remove('drag-over');
        APP.currentMap[col] = e.dataTransfer.getData('text');
        applyMapping();
    }

    function resetMapping() { APP.currentMap = {...DEFAULT_MAP}; applyMapping(); }

    // --- UTILS FOR XML ---
    function fmtDate(d) {
        // Input: YYYYMMDD or Date Object -> Output: YYYY-MM-DD
        if(!d) return "2025-01-01";
        if(d.includes("-")) return d; // Already formatted
        if(d.length === 8) return `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
        return d;
    }

    function fmtDateTime(d) {
        // Input: YYYYMMDD -> Output: YYYY-MM-DDThh:mm:ss
        return fmtDate(d) + "T00:00:00";
    }

    function escapeXml(s) { return s.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','"':'&quot;'}[c])); }

    // --- XML EXPORT (100% HARIBO MIRROR) ---
    function exportMasterXML() {
        if(!APP.gkData.length) return alert("Please load data first");
        
        let xml = `<?xml version="1.0" encoding="UTF-8"?>
<ItemList xmlns:importDomain="http://www.gk-software.com/storeweaver/master_data/import_domain/2.2.0" xsi:schemaLocation="http://www.gk-software.com/storeweaver/master_data/item/3.4.0 xsd/masterData_Item.xsd" NumberOfItems="${APP.gkData.length}" xmlns="http://www.gk-software.com/storeweaver/master_data/item/3.4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
`;
        
        APP.gkData.forEach(r => {
            // Default safe values based on Haribo
            const baseUom = r.BaseUOMCode || 'PCE';
            const itemName = escapeXml(r.BonText || 'Unknown Item');
            const itemDesc = escapeXml(r.Description || r.BonText || 'Unknown Item');

            xml += `\t<Item ChangeType="DIRECT">\n`;
            xml += `\t\t<BusinessUnitAssignment>\n\t\t\t<BusinessUnitID>${r.BusinessUnitID || '1000'}</BusinessUnitID>\n\t\t</BusinessUnitAssignment>\n`;
            xml += `\t\t<ItemID>${r.ItemID || ''}</ItemID>\n`;
            xml += `\t\t<BonText>${itemName}</BonText>\n`;
            xml += `\t\t<Description>${itemDesc}</Description>\n`;
            xml += `\t\t<TaxGroupID>${r.TaxGroupID || 'A1'}</TaxGroupID>\n`;
            xml += `\t\t<UpdateStockFlag>${r.UpdateStockFlag || 'true'}</UpdateStockFlag>\n`;
            xml += `\t\t<BaseUOMCode>${baseUom}</BaseUOMCode>\n`;
            xml += `\t\t<MinimumShelfLifeDayCount>${r.MinimumShelfLifeDayCount || '0'}</MinimumShelfLifeDayCount>\n`;
            xml += `\t\t<ClassCode>${r.ClassCode || 'HAWA'}</ClassCode>\n`;
            xml += `\t\t<TaxExemptCode>${r.TaxExemptCode || '00'}</TaxExemptCode>\n`;
            xml += `\t\t<WarrantyPeriod>${r.WarrantyPeriod || '0'}</WarrantyPeriod>\n`;
            xml += `\t\t<LabelType>${r.LabelType || 'HAWA'}</LabelType>\n`;
            xml += `\t\t<ItemUsageTypeCode>${r.ItemUsageTypeCode || '00'}</ItemUsageTypeCode>\n`;
            xml += `\t\t<GlobalLifeDayCount>${r.GlobalLifeDayCount || '0'}</GlobalLifeDayCount>\n`;
            xml += `\t\t<ShelfLifeDayCountPercent>${r.ShelfLifeDayCountPercent || '0'}</ShelfLifeDayCountPercent>\n`;
            xml += `\t\t<PhoneCardLoadingTypeCode>${r.PhoneCardLoadingTypeCode || '01'}</PhoneCardLoadingTypeCode>\n`; // Haribo has 01
            xml += `\t\t<DefaultReceivingLocation>${r.DefaultReceivingLocation || '123'}</DefaultReceivingLocation>\n`;
            xml += `\t\t<CostItemFlag>${r.CostItemFlag || 'true'}</CostItemFlag>\n`;
            xml += `\t\t<MerchandisePlanningTypeCode>${r.MerchandisePlanningTypeCode || 'RP'}</MerchandisePlanningTypeCode>\n`;
            xml += `\t\t<MainSupplierID>${r.MainSupplierID || '0000100001'}</MainSupplierID>\n`; // Default fallback from sample
            xml += `\t\t<BaseUOMConsumerPackageNetContent>${r.BaseUOMConsumerPackageNetContent || '1'}</BaseUOMConsumerPackageNetContent>\n`;
            xml += `\t\t<BaseUOMConsumerPackageContentsUOMCode>${r.BaseUOMConsumerPackageContentsUOMCode || baseUom}</BaseUOMConsumerPackageContentsUOMCode>\n`;
            xml += `\t\t<BaseUOMConsumerPackageBasePriceContent>${r.BaseUOMConsumerPackageBasePriceContent || '1'}</BaseUOMConsumerPackageBasePriceContent>\n`;
            xml += `\t\t<BaseUOMConsumerPackageBasePriceContentsUOMCode>${r.BaseUOMConsumerPackageBasePriceContentsUOMCode || baseUom}</BaseUOMConsumerPackageBasePriceContentsUOMCode>\n`;
            xml += `\t\t<DistributingWarehouseID>${r.DistributingWarehouseID || '1'}</DistributingWarehouseID>\n`;
            xml += `\t\t<AssortmentID>${r.AssortmentID || 'A'}</AssortmentID>\n`;
            xml += `\t\t<ThirdPartyAssortmentID>${r.ThirdPartyAssortmentID || 'A'}</ThirdPartyAssortmentID>\n`;
            xml += `\t\t<TransportAssociationID>${r.TransportAssociationID || '0'}</TransportAssociationID>\n`;
            xml += `\t\t<DefaultSellingUOMCode>${r.DefaultSellingUOMCode || baseUom}</DefaultSellingUOMCode>\n`;
            
            // --- ItemTextList (Mirroring Haribo Structure) ---
            xml += `\t\t<ItemTextList>\n`;
            // KTXT (Short Text)
            xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>KTXT</TextClass>\n\t\t\t\t<Text>${itemName}</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
            // STST (Placeholder)
            xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>STST</TextClass>\n\t\t\t\t<Text>STST</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
            // STXT (Placeholder)
            xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>STXT</TextClass>\n\t\t\t\t<Text>STXT</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
             // SAIC (Placeholder - Image)
             xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>SAIC</TextClass>\n\t\t\t\t<Text>SAIC</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
             // SICO (Placeholder)
             xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>SICO</TextClass>\n\t\t\t\t<Text>SICO</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
             // AATE (Placeholder)
             xml += `\t\t\t<ItemText>\n\t\t\t\t<TextClass>AATE</TextClass>\n\t\t\t\t<Text>AATE</Text>\n\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t</ItemText>\n`;
            xml += `\t\t</ItemTextList>\n`;

            // --- BulkItem ---
            xml += `\t\t<BulkItem>\n\t\t\t<TareID>0</TareID>\n\t\t\t<AfterPackLeftLifeDayCount>0</AfterPackLeftLifeDayCount>\n\t\t\t<ScalesFlag>false</ScalesFlag>\n\t\t\t<LabellingMachineFlag>false</LabellingMachineFlag>\n\t\t</BulkItem>\n`;

            // --- UOMItemList ---
            xml += `\t\t<UOMItemList>\n\t\t\t<UOMItem>\n`;
            xml += `\t\t\t\t<UOMCode>${r.UOMCode || baseUom}</UOMCode>\n`;
            xml += `\t\t\t\t<ConversionNumerator>${r.ConversionNumerator || '1'}</ConversionNumerator>\n`;
            xml += `\t\t\t\t<ConversionDenominator>${r.ConversionDenominator || '1'}</ConversionDenominator>\n`;
            xml += `\t\t\t\t<ConsumerPackageNetWeight>${r.ConsumerPackageNetWeight || '1'}</ConsumerPackageNetWeight>\n`;
            xml += `\t\t\t\t<ConsumerPackageWeightUOMCode>${r.ConsumerPackageWeightUOMCode || 'ST'}</ConsumerPackageWeightUOMCode>\n`;
            xml += `\t\t\t\t<ConsumerPackageSizeUOMCode>${r.ConsumerPackageSizeUOMCode || baseUom}</ConsumerPackageSizeUOMCode>\n`;
            xml += `\t\t\t\t<ConsumerPackageBasePriceUOMCode>${r.ConsumerPackageBasePriceUOMCode || baseUom}</ConsumerPackageBasePriceUOMCode>\n`;
            xml += `\t\t\t\t<POSDepartmentID>${r.POSDepartmentID || '1'}</POSDepartmentID>\n`;
            xml += `\t\t\t\t<MainPOSItemID>${r.MainPOSItemID || ''}</MainPOSItemID>\n`;
            xml += `\t\t\t\t<StatusCode>${r.StatusCode || 'F'}</StatusCode>\n`;
            xml += `\t\t\t\t<MaximumStockQuantity>${r.MaximumStockQuantity || '999'}</MaximumStockQuantity>\n`;
            xml += `\t\t\t\t<MinimumStockQuantity>${r.MinimumStockQuantity || '5'}</MinimumStockQuantity>\n`;
            xml += `\t\t\t\t<ListingEffectiveDate>${fmtDate(r.ListingEffectiveDate)}</ListingEffectiveDate>\n`;
            xml += `\t\t\t\t<ListingExpirationDate>${fmtDate(r.ListingExpirationDate)}</ListingExpirationDate>\n`;
            xml += `\t\t\t\t<MainMerchandiseHierarchyGroupID>${r.MainMerchandiseHierarchyGroupID || ''}</MainMerchandiseHierarchyGroupID>\n`;

            // ItemSellingRule
            xml += `\t\t\t\t<ItemSellingRule>\n\t\t\t\t\t<ProhibitReturnFlag>true</ProhibitReturnFlag>\n\t\t\t\t\t<PriceEntryRequiredFlag>false</PriceEntryRequiredFlag>\n\t\t\t\t\t<AllowFoodStampFlag>false</AllowFoodStampFlag>\n\t\t\t\t\t<WICFlag>false</WICFlag>\n\t\t\t\t\t<AuthorizedForSaleFlag>true</AuthorizedForSaleFlag>\n\t\t\t\t\t<DiscountFlag>false</DiscountFlag>\n\t\t\t\t\t<BonuspointsFlag>true</BonuspointsFlag>\n\t\t\t\t\t<QuantityInputTypeCode>00</QuantityInputTypeCode>\n\t\t\t\t\t<QuantityInputMethod>01</QuantityInputMethod>\n\t\t\t\t\t<PriceChangeTypeCode>00</PriceChangeTypeCode>\n\t\t\t\t\t<WeightEntryRequiredFlag>false</WeightEntryRequiredFlag>\n\t\t\t\t</ItemSellingRule>\n`;

            // ItemMerchandiseManagementRule
            xml += `\t\t\t\t<ItemMerchandiseManagementRule>\n\t\t\t\t\t<PriceEntryRequiredFlag>false</PriceEntryRequiredFlag>\n\t\t\t\t\t<QuantityInputTypeCode>00</QuantityInputTypeCode>\n\t\t\t\t\t<WeightEntryRequiredFlag>false</WeightEntryRequiredFlag>\n\t\t\t\t\t<DefaultLayoutClass>STST</DefaultLayoutClass>\n\t\t\t\t\t<DefaultLabelCount>1</DefaultLabelCount>\n\t\t\t\t</ItemMerchandiseManagementRule>\n`;

            // PriceList
            xml += `\t\t\t\t<PriceList>\n\t\t\t\t\t<Price>\n`;
            xml += `\t\t\t\t\t\t<Price>${parseFloat(r.Price || 0).toFixed(2)}</Price>\n`;
            xml += `\t\t\t\t\t\t<EffectiveDate>${fmtDateTime(r.EffectiveDate)}</EffectiveDate>\n`;
            xml += `\t\t\t\t\t\t<ExpirationDate>${fmtDateTime(r.ExpirationDate)}</ExpirationDate>\n`;
            xml += `\t\t\t\t\t\t<PriceTypeCode>${r.PriceTypeCode || '01'}</PriceTypeCode>\n`;
            xml += `\t\t\t\t\t</Price>\n\t\t\t\t</PriceList>\n`;

            // EANList
            xml += `\t\t\t\t<EANList>\n\t\t\t\t\t<EAN>\n`;
            xml += `\t\t\t\t\t\t<PosItemID>${r.PosItemID || r.MainPOSItemID || ''}</PosItemID>\n`;
            xml += `\t\t\t\t\t\t<PosIdentityTypeCode>${r.PosIdentityTypeCode || '10'}</PosIdentityTypeCode>\n`;
            xml += `\t\t\t\t\t</EAN>\n\t\t\t\t</EANList>\n`;

            // Empty Lists (Explicitly added to match Haribo)
            xml += `\t\t\t\t<SalesRestrictionList/>\n`;
            xml += `\t\t\t\t<ItemDepositCollectionList/>\n`;

            // UOMItemTextList (Matching Haribo Variety)
            xml += `\t\t\t\t<UOMItemTextList>\n`;
            // 1. STST (Short Text)
            xml += `\t\t\t\t\t<UOMItemText>\n\t\t\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t\t\t\t<TextClass>STST</TextClass>\n\t\t\t\t\t\t<LanguageID>en_US</LanguageID>\n\t\t\t\t\t\t<Text>${itemName}</Text>\n\t\t\t\t\t</UOMItemText>\n`;
            // 2. STXT (Longer Text)
            xml += `\t\t\t\t\t<UOMItemText>\n\t\t\t\t\t\t<TextNumber>9</TextNumber>\n\t\t\t\t\t\t<TextClass>STXT</TextClass>\n\t\t\t\t\t\t<LanguageID>en_US</LanguageID>\n\t\t\t\t\t\t<Text>${itemName}</Text>\n\t\t\t\t\t</UOMItemText>\n`;
            // 3. AATE (Placeholder Marketing Text)
            xml += `\t\t\t\t\t<UOMItemText>\n\t\t\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t\t\t\t<TextClass>AATE</TextClass>\n\t\t\t\t\t\t<LanguageID>en_US</LanguageID>\n\t\t\t\t\t\t<Text>${itemDesc}</Text>\n\t\t\t\t\t</UOMItemText>\n`;
            // 4. SATE (Placeholder Shelf Text)
            xml += `\t\t\t\t\t<UOMItemText>\n\t\t\t\t\t\t<TextNumber>1</TextNumber>\n\t\t\t\t\t\t<TextClass>SATE</TextClass>\n\t\t\t\t\t\t<LanguageID>en_US</LanguageID>\n\t\t\t\t\t\t<Text>${itemDesc}</Text>\n\t\t\t\t\t</UOMItemText>\n`;
             // 5. SAIC (Image - Placeholder)
             xml += `\t\t\t\t\t<UOMItemText>\n\t\t\t\t\t\t<TextNumber>5</TextNumber>\n\t\t\t\t\t\t<TextClass>SAIC</TextClass>\n\t\t\t\t\t\t<LanguageID>en_US</LanguageID>\n\t\t\t\t\t\t<Text>default_image.jpg</Text>\n\t\t\t\t\t</UOMItemText>\n`;
            xml += `\t\t\t\t</UOMItemTextList>\n`;

            // ItemMHGList
            xml += `\t\t\t\t<ItemMHGList>\n\t\t\t\t\t<ItemMHG>\n`;
            xml += `\t\t\t\t\t\t<MerchandiseHierarchyGroupID>${r.MerchandiseHierarchyGroupID || ''}</MerchandiseHierarchyGroupID>\n`;
            xml += `\t\t\t\t\t\t<MerchandiseHierarchyGroupIDQualifier>MAIN</MerchandiseHierarchyGroupIDQualifier>\n`;
            xml += `\t\t\t\t\t</ItemMHG>\n\t\t\t\t</ItemMHGList>\n`;

            xml += `\t\t\t</UOMItem>\n\t\t</UOMItemList>\n`;
            xml += `\t</Item>\n`;
        });
        
        xml += `</ItemList>`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([xml], {type: 'text/xml'}));
        a.download = "ItemMasterData_Export.xml";
        a.click();
    }

    // --- DRAG & DROP UI HELPERS ---
    function dragStart(e,k) { e.dataTransfer.setData("text", k); }
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function drop(e,col) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); APP.currentMap[col] = e.dataTransfer.getData("text"); applyMapping(); }
    function switchMainTab(t) { document.querySelectorAll('.view-section,.tab').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${t}`).classList.add('active'); event.target.classList.add('active'); }
    document.getElementById('div-m').addEventListener('mousedown', (e) => { e.preventDefault(); const h=document.getElementById('p-top').offsetHeight; const mm=(ev)=>document.getElementById('p-top').style.flex=`0 0 ${h+(ev.clientY-e.clientY)}px`; const mu=()=>{document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);}; document.addEventListener('mousemove',mm); document.addEventListener('mouseup',mu); });
</script>
</body>
</html>
