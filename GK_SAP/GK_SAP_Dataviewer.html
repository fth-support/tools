<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v20 - Body Structure Order</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #217346; --accent: #107c41; --sap: #e67e22; --bg: #f3f2f1; --border: #e1dfdd; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        
        header { background: var(--primary); color: white; padding: 0 15px; height: 42px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: 600; font-size: 14px; display:flex; align-items:center; gap:8px; }
        .global-btn { background: white; border: 1px solid white; padding: 4px 12px; color: var(--primary); border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 11px; transition:0.2s; }
        .global-btn:hover { background: #f0f0f0; }

        #main-container { display: flex; flex: 1; flex-direction: column; height: calc(100vh - 42px); overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; background: white; min-height: 0; overflow: hidden; }
        
        .toolbar { padding: 6px 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; height:30px; }
        .label-xml { color: #107c41; font-weight: 700; font-size: 12px; width: 80px; }
        .label-json { color: #e67e22; font-weight: 700; font-size: 12px; width: 80px; }
        
        .btn-tool { padding: 4px 10px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 11px; border-radius: 2px; display:flex; align-items:center; gap:5px; }
        .btn-tool:hover { background: #eee; border-color: #bbb; }
        
        .table-container { flex: 1; overflow: auto; position: relative; background: #fff; }
        table { border-collapse: collapse; table-layout: fixed; width: 0; font-size: 11px; color: #333; }
        
        th { 
            background: #f3f2f1; border-right: 1px solid #d0d0d0; border-bottom: 2px solid #c0c0c0;
            padding: 0; margin: 0; height: 26px; text-align: left; position: sticky; top: 0; z-index: 10; 
            font-weight: 600; color: #444; min-width: 0 !important; user-select: none;
        }
        
        .th-inner { padding: 0 6px; height:100%; display:flex; align-items:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; cursor: grab; }
        .th-inner:active { cursor: grabbing; }

        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; z-index: 20; }
        .resizer:hover { background: #107c41; }

        td { border-right: 1px solid #e1dfdd; border-bottom: 1px solid #e1dfdd; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: clip; min-width: 0 !important; height: 22px; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #e8f5e9; }
        th.drag-over { border-left: 3px solid #107c41 !important; }

        .divider { height: 6px; background: #e1dfdd; cursor: row-resize; z-index: 50; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; }
        .divider:hover { background: #d0d0d0; }
    </style>
</head>
<body>

<header>
    <div class="app-title">üìä GK Analyzer v20 - Body Order (Strict)</div>
    <button class="global-btn" onclick="exportExcel()">‚¨á Export Excel</button>
</header>

<div id="main-container">
    <div class="panel" id="panel-top" style="flex: 1;">
        <div class="toolbar">
            <span class="label-xml">GK POS (XML)</span>
            <button class="btn-tool" onclick="document.getElementById('xmlInput').click()">üìÇ Load XML Folder</button>
            <input type="file" id="xmlInput" multiple webkitdirectory style="display:none">
            <button class="btn-tool" onclick="APP.xml.data=[]; renderTable('xml');">‚ùå Clear</button>
            <span id="xml-status" style="font-size:10px; color:#888; margin-left:auto;">Ready</span>
        </div>
        <div class="table-container"><table id="xmlTable"><thead id="xmlHead"></thead><tbody id="xmlBody"></tbody></table></div>
    </div>

    <div class="divider" id="drag-divider"></div>

    <div class="panel" id="panel-bottom" style="flex: 1;">
        <div class="toolbar">
            <span class="label-json">SAP (JSON)</span>
            <button class="btn-tool" onclick="document.getElementById('jsonInput').click()">üìÇ Load JSON File</button>
            <input type="file" id="jsonInput" multiple accept=".json" style="display:none">
            <button class="btn-tool" onclick="APP.json.data=[]; renderTable('json');">‚ùå Clear</button>
            <span id="json-status" style="font-size:10px; color:#888; margin-left:auto;">Ready</span>
        </div>
        <div class="table-container"><table id="jsonTable"><thead id="jsonHead"></thead><tbody id="jsonBody"></tbody></table></div>
    </div>
</div>

<script>
    const APP = {
        xml: { data: [], columns: [], sort: {key:null, asc:true} },
        json: { data: [], columns: [], sort: {key:null, asc:true} }
    };

    document.getElementById('xmlInput').addEventListener('change', (e) => loadFiles(e.target.files, 'xml'));
    document.getElementById('jsonInput').addEventListener('change', (e) => loadFiles(e.target.files, 'json'));

    async function loadFiles(files, type) {
        if (!files.length) return;
        APP[type].data = [];
        
        // Use Set to maintain Insertion Order (Document Order)
        let orderedKeys = new Set(); 

        for (let file of Array.from(files)) {
            const text = await file.text();
            let row = { "FileName": file.name }; // FileName is always first by logic below, but we handle it specifically

            if (type === 'xml') {
                if (!file.name.toLowerCase().endsWith('.xml')) continue;
                const xml = new DOMParser().parseFromString(text, "text/xml");
                flattenXML_DocOrder(xml.documentElement, row);
                APP[type].data.push(row);
            } else {
                if (!file.name.toLowerCase().endsWith('.json')) continue;
                try {
                    const json = JSON.parse(text);
                    let items = json.RetailIncentiveERPStoreOfferReplicationBulkRequest_V1?.RetailIncentiveERPStoreOfferReplicationRequestMessage_V1 || 
                                json.AssortmentSend_MT?.AssortmentList || [json];
                    if(!Array.isArray(items)) items = [items];
                    
                    items.forEach(item => {
                        let subRow = { "FileName": file.name };
                        flattenJSON_DocOrder(item, subRow, "");
                        APP[type].data.push(subRow);
                    });
                } catch(e) { console.error(e); }
            }
        }

        // Extract Columns in Order of Appearance
        // We iterate through all rows to ensure we capture keys from all files
        // Set will prevent duplicates but keep the order of first insertion
        APP[type].data.forEach(r => {
            Object.keys(r).forEach(k => {
                if(k !== "FileName") orderedKeys.add(k);
            });
        });

        // Force FileName to be first, then the rest in Document Order
        APP[type].columns = ["FileName", ...Array.from(orderedKeys)];

        renderTable(type);
        document.getElementById(`${type}-status`).textContent = `${APP[type].data.length} records`;
    }

    // --- XML FLATTENER (Document Order) ---
    function flattenXML_DocOrder(node, res, prefix = "") {
        if (node.children.length === 0) {
            let val = node.textContent.trim();
            if (val) {
                let key = node.nodeName;
                // Excel-style naming logic
                const simpleKeys = ["PromotionID", "Description", "BusinessUnitID", "PriceModificationAmount", "PriceModificationPercent", "NewPriceAmount"];
                if (!simpleKeys.includes(key) && (prefix.includes("Rule") || prefix.includes("Eligibility"))) {
                    let parent = prefix.split('_').filter(p=>p).pop(); 
                    if(parent) key = parent + "_" + key;
                }
                res[key] = res[key] ? res[key] + "," + val : val;
            }
        } else {
            // Iterating children array preserves Document Order
            Array.from(node.children).forEach(child => {
                let newPrefix = prefix;
                if(["PromotionConditionRule", "PromotionConditionEligibility", "RebatePromotionConditionRule"].includes(child.nodeName)) {
                     newPrefix += child.nodeName + "_";
                }
                flattenXML_DocOrder(child, res, newPrefix);
            });
        }
    }

    // --- JSON FLATTENER (Document Order) ---
    function flattenJSON_DocOrder(obj, res, prefix) {
        // for..in loops in modern JS generally preserve string key insertion order (except for integers)
        for (let k in obj) {
            let v = obj[k];
            let newKey = prefix ? (k === "$" ? prefix + ".$" : prefix + "." + k) : k;

            if (v === null) continue;

            if (Array.isArray(v)) {
                if (v.length > 0 && typeof v[0] === 'object') {
                    // Extract keys from the first object to maintain sub-structure order
                    let subKeys = new Set();
                    v.forEach(item => {
                        // We must traverse item to find its keys in order
                        flattenKeysOrder(item, "", subKeys);
                    });
                    
                    subKeys.forEach(sk => {
                        let fullSubKey = newKey + (sk.startsWith(".") ? "" : ".") + sk;
                        let values = v.map(item => {
                            let val = getDeepValue(item, sk);
                            return val !== undefined ? val : "";
                        }).filter(val => val !== "").join(","); 
                        if(values !== "") res[fullSubKey] = values;
                    });
                } else {
                    res[newKey] = v.join(",");
                }
            } 
            else if (typeof v === 'object') {
                flattenJSON_DocOrder(v, res, newKey);
            } 
            else {
                res[newKey] = v;
            }
        }
    }

    // Helper to collect keys in order
    function flattenKeysOrder(obj, prefix, set) {
        for(let k in obj) {
            let p = prefix ? (k==="$" ? prefix+".$" : prefix+"."+k) : k;
            if(typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                flattenKeysOrder(obj[k], p, set);
            } else {
                set.add(p);
            }
        }
    }

    function getDeepValue(obj, path) {
        return path.split('.').reduce((o, i) => {
            if(i === "$") return o && o["$"];
            return o ? o[i] : undefined; 
        }, obj);
    }

    // --- RENDER ---
    function renderTable(type) {
        const thead = document.getElementById(`${type}Head`);
        const tbody = document.getElementById(`${type}Body`);
        const cols = APP[type].columns;

        thead.innerHTML = `<tr>${cols.map(k => `
            <th style="width:120px;" draggable="true" data-key="${k}" data-type="${type}">
                <div class="th-inner" onclick="doSort('${type}','${k}')">
                    ${formatHeader(k)} ${APP[type].sort.key===k ? (APP[type].sort.asc?'‚ñ≤':'‚ñº') : ''}
                </div>
                <div class="resizer" onmousedown="initResize(event)"></div>
            </th>`).join('')}</tr>`;
            
        tbody.innerHTML = APP[type].data.map(r => `<tr>${cols.map(k => `<td title="${r[k]||''}">${r[k]||''}</td>`).join('')}</tr>`).join('');
        attachHeaderEvents(type);
    }

    function formatHeader(k) {
        // Clean prefixes for display only, maintain full path for sorting/key
        return k.replace('RetailIncentiveERPStoreOfferReplicationBulkRequest_V1.', '')
                .replace('RetailIncentive.', '')
                .replace('Offer.Get.', 'Get.')
                .replace('Offer.Buy.', 'Buy.')
                .replace('.0.Description.0.$', '_Desc')
                .replace('.$', ' ($)');
    }

    // --- UTILS (Resize, Sort, Export) ---
    function initResize(e) {
        e.preventDefault(); e.stopPropagation();
        const th = e.target.parentElement;
        const startX = e.clientX; const startW = th.offsetWidth;
        const mm = (ev) => th.style.width = Math.max(0, startW + (ev.clientX - startX)) + "px";
        const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
        document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    }

    function doSort(type, key) {
        let s = APP[type].sort;
        s.asc = s.key===key ? !s.asc : true; s.key=key;
        APP[type].data.sort((a,b) => (a[key]||"").toString().localeCompare((b[key]||"").toString()) * (s.asc?1:-1));
        renderTable(type);
    }

    function attachHeaderEvents(type) {
        let dragSrc = null;
        document.querySelectorAll(`#${type}Head th`).forEach(th => {
            th.addEventListener('dragstart', (e) => { dragSrc = th.dataset.key; e.dataTransfer.effectAllowed='move'; });
            th.addEventListener('dragover', (e) => { e.preventDefault(); th.classList.add('drag-over'); });
            th.addEventListener('dragleave', () => th.classList.remove('drag-over'));
            th.addEventListener('drop', (e) => {
                e.preventDefault(); th.classList.remove('drag-over');
                if(dragSrc !== th.dataset.key) {
                    const arr = APP[type].columns;
                    const f = arr.indexOf(dragSrc), t = arr.indexOf(th.dataset.key);
                    arr.splice(t, 0, arr.splice(f, 1)[0]);
                    renderTable(type);
                }
            });
            th.querySelector('.resizer').addEventListener('dblclick', (e) => {
                let k = th.dataset.key;
                let max = k.length;
                APP[type].data.forEach(r => { let l = (r[k]||"").toString().length; if(l>max) max=l; });
                th.style.width = (max*7 + 30) + "px";
            });
        });
    }

    const divider = document.getElementById('drag-divider');
    divider.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const startY = e.clientY;
        const startH = document.getElementById('panel-top').offsetHeight;
        const mm = (ev) => {
            let newH = startH + (ev.clientY - startY);
            if(newH > 50 && newH < document.body.offsetHeight-50) document.getElementById('panel-top').style.flex = `0 0 ${newH}px`;
        };
        const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
        document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    });

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        if(APP.xml.data.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_book(document.getElementById('xmlTable')), "GK_XML");
        if(APP.json.data.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_book(document.getElementById('jsonTable')), "SAP_JSON");
        XLSX.writeFile(wb, "GK_SAP_Ordered_Flat.xlsx");
    }
</script>
</body>
</html>
