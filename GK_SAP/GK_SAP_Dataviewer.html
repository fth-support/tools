<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>GK Analyzer v26 - Mirror XML</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --sap: #e67e22; --gk: #8e44ad; --bg: #ecf0f1; --border: #bdc3c7; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: var(--bg); overflow: hidden; }
        
        nav { background: var(--primary); color: white; display: flex; padding: 0 15px; height: 45px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .app-title { font-weight: bold; font-size: 15px; }
        .tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .tab { padding: 10px 20px; cursor: pointer; background: #34495e; color: #bbb; border-radius: 5px 5px 0 0; font-size: 12px; font-weight: 600; }
        .tab.active { background: #ecf0f1; color: #2c3e50; border-bottom: 3px solid var(--accent); }

        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .view-section { display: none; flex: 1; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        .split-container { display: flex; flex: 1; flex-direction: column; overflow: hidden; }
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; background: white; }
        .divider { height: 8px; background: #ddd; cursor: row-resize; z-index: 50; flex-shrink: 0; border-top: 1px solid #ccc; border-bottom: 1px solid #ccc; }

        .toolbar { padding: 6px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; height: 35px; flex-shrink: 0; }
        .btn-tool { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 11px; border-radius: 3px; font-weight: 600; }
        .btn-green { background: var(--accent); color: white; border: none; }

        .table-wrapper { flex: 1; overflow: auto; background: white; }
        table { border-collapse: collapse; min-width: 100%; font-size: 11px; table-layout: fixed; width: 0; }
        th { background: #f4f4f4; border: 1px solid #ddd; padding: 8px; text-align: left; position: sticky; top: 0; z-index: 10; font-weight: 700; white-space: nowrap; }
        td { border: 1px solid #eee; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .draggable-header { cursor: grab; }
        th.drag-over { background: #e8f8f5 !important; border: 2px dashed #27ae60 !important; }
        .mapped-badge { font-size: 9px; background: #dff0d8; color: #3c763d; padding: 1px 3px; border-radius: 3px; margin-left: 5px; }
        td.empty-cell { background-color: #fff0f0; }
    </style>
</head>
<body>

<nav>
    <div class="app-title">üì¶ GK Analyzer v26 - Mirror XML</div>
    <div class="tabs">
        <div class="tab" onclick="switchMainTab('bi')">1. BI Overview</div>
        <div class="tab" onclick="switchMainTab('promo')">2. Promo (Compare)</div>
        <div class="tab active" onclick="switchMainTab('master')">3. Master (Mirror Map)</div>
    </div>
</nav>

<div id="main-container">
    <div id="view-bi" class="view-section"></div>
    <div id="view-promo" class="view-section"></div>

    <div id="view-master" class="view-section active">
        <div class="split-container">
            <div class="panel" id="panel-master-top">
                <div class="toolbar">
                    <b style="color:var(--sap);">üüß SAP Source (Sku.json)</b>
                    <button class="btn-tool" onclick="document.getElementById('skuInput').click()">üìÇ Load Master</button>
                    <input type="file" id="skuInput" multiple accept=".json" style="display:none">
                </div>
                <div class="table-wrapper"><table id="sapMasterTable"><thead id="sapMasterHead"></thead><tbody id="sapMasterBody"></tbody></table></div>
            </div>
            
            <div class="divider" id="div-master"></div>

            <div class="panel" id="panel-master-bottom">
                <div class="toolbar">
                    <b style="color:var(--gk);">üü™ GK Mirror Template (Haribo Style)</b>
                    <button class="btn-tool" onclick="resetMasterMapping()">‚Ü∫ Reset</button>
                    <button class="btn-tool btn-green" onclick="exportMirrorXML()">‚¨á Export XML (100% Mirror)</button>
                </div>
                <div class="table-wrapper"><table id="gkMasterTable"><thead id="gkMasterHead"></thead><tbody id="gkMasterBody"></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script>
    const MASTER = {
        sapData: [], sapKeys: [], gkData: [], currentMap: {},
        // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏° Haribo XML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        gkColumns: [
            "BusinessUnitID", "ItemID", "MainPOSItemID", "BonText", "Description", 
            "TaxGroupID", "UpdateStockFlag", "BaseUOMCode", "MinimumShelfLifeDayCount",
            "ClassCode", "TaxExemptCode", "WarrantyPeriod", "LabelType", "ItemUsageTypeCode",
            "MerchandiseHierarchyGroupID", "RegularSalesUnitPrice"
        ],
        defaultMap: {
            "BusinessUnitID": "LOCNR", "ItemID": "MATNR", "MainPOSItemID": "EAN_List",
            "BonText": "MAKTX", "Description": "MAKTX", "TaxGroupID": "CONST_A1",
            "UpdateStockFlag": "CONST_true", "BaseUOMCode": "MEINH", "MinimumShelfLifeDayCount": "CONST_0",
            "ClassCode": "CONST_HAWA", "TaxExemptCode": "CONST_00", "WarrantyPeriod": "CONST_0",
            "LabelType": "CONST_HAWA", "ItemUsageTypeCode": "CONST_00",
            "MerchandiseHierarchyGroupID": "MATKL", "RegularSalesUnitPrice": "SAP_Price"
        }
    };

    MASTER.currentMap = {...MASTER.defaultMap};
    renderGKMasterHeader();
    document.getElementById('skuInput').addEventListener('change', (e) => loadMasterFiles(e.target.files));

    function switchMainTab(t) {
        document.querySelectorAll('.view-section, .tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${t}`).classList.add('active');
        event.target.classList.add('active');
    }

    async function loadMasterFiles(files) {
        if (!files.length) return;
        MASTER.sapData = [];
        let allKeys = new Set();
        for (let file of Array.from(files)) {
            const json = JSON.parse(await file.text());
            let items = json.AssortmentSend_MT?.AssortmentList || [json];
            if (!Array.isArray(items)) items = [items];
            items.forEach(item => {
                let flat = {};
                flattenJSON(item, flat, "");
                // Price & EAN Logic
                if (item.UOM?.[0]) {
                    let u = item.UOM.find(x => x.MEINH === 'EA') || item.UOM[0];
                    flat['MEINH'] = u.MEINH;
                    flat['EAN_List'] = u.EAN11 || u.EAN?.[0]?.EAN11 || "";
                    flat['SAP_Price'] = u.CONDITION?.find(c => c.KSCHL === 'VKP1')?.CONDITION_VALUE?.[0]?.KWERT || "0";
                }
                flat['MAKTX'] = item.MATTEXT?.find(t => t.SPRAS === 'E')?.MAKTX || item.MATTEXT?.[0]?.MAKTX || "";
                if(flat['MATNR']) flat['MATNR'] = flat['MATNR'].replace(/^0+/, '');
                MASTER.sapData.push(flat);
            });
        }
        MASTER.sapData.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));
        MASTER.sapKeys = Array.from(allKeys).sort();
        renderSapMasterTable(); applyMasterMapping();
    }

    function flattenJSON(obj, res, prefix) {
        for (let k in obj) {
            let key = prefix ? prefix + "." + k : k;
            if (obj[k] !== null && typeof obj[k] === 'object' && !Array.isArray(obj[k])) flattenJSON(obj[k], res, key);
            else if (Array.isArray(obj[k])) res[key] = JSON.stringify(obj[k]);
            else res[key] = obj[k];
        }
    }

    function renderSapMasterTable() {
        document.getElementById('sapMasterHead').innerHTML = `<tr>${MASTER.sapKeys.map(k => `<th draggable="true" ondragstart="dragStart(event,'${k}')" class="draggable-header" style="width:120px;">${k}</th>`).join('')}</tr>`;
        document.getElementById('sapMasterBody').innerHTML = MASTER.sapData.slice(0, 50).map(r => `<tr>${MASTER.sapKeys.map(k => `<td>${r[k]||''}</td>`).join('')}</tr>`).join('');
    }

    function renderGKMasterHeader() {
        document.getElementById('gkMasterHead').innerHTML = `<tr>${MASTER.gkColumns.map(col => `<th ondragover="allowDrop(event)" ondrop="drop(event,'${col}')" style="width:120px;">${col} ${MASTER.currentMap[col] && !MASTER.currentMap[col].startsWith("CONST_") ? `<span class="mapped-badge">‚Üê ${MASTER.currentMap[col]}</span>` : ''}</th>`).join('')}</tr>`;
    }

    function applyMasterMapping() {
        MASTER.gkData = MASTER.sapData.map(sapRow => {
            let row = {};
            MASTER.gkColumns.forEach(col => {
                let k = MASTER.currentMap[col];
                row[col] = !k ? "" : (k.startsWith("CONST_") ? k.replace("CONST_", "") : sapRow[k] || "");
            });
            return row;
        });
        renderGKMasterHeader();
        document.getElementById('gkMasterBody').innerHTML = MASTER.gkData.slice(0, 50).map(r => `<tr>${MASTER.gkColumns.map(c => `<td class="${!r[c]?'empty-cell':''}">${r[c]||''}</td>`).join('')}</tr>`).join('');
    }

    function exportMirrorXML() {
        if(!MASTER.gkData.length) return alert("No data");
        let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
        xml += `<ItemList xmlns:importDomain="http://www.gk-software.com/storeweaver/master_data/import_domain/2.2.0" xsi:schemaLocation="http://www.gk-software.com/storeweaver/master_data/item/3.4.0 xsd/masterData_Item.xsd" NumberOfItems="${MASTER.gkData.length}" xmlns="http://www.gk-software.com/storeweaver/master_data/item/3.4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n`;
        
        MASTER.gkData.forEach(r => {
            xml += `\t<Item ChangeType="DIRECT">\n`;
            xml += `\t\t<BusinessUnitAssignment>\n\t\t\t<BusinessUnitID>${r.BusinessUnitID}</BusinessUnitID>\n\t\t</BusinessUnitAssignment>\n`;
            xml += `\t\t<ItemID>${r.ItemID}</ItemID>\n`;
            xml += `\t\t<MainPOSItemID>${r.MainPOSItemID}</MainPOSItemID>\n`;
            xml += `\t\t<BonText>${escapeXml(r.BonText)}</BonText>\n`;
            xml += `\t\t<Description>${escapeXml(r.Description)}</Description>\n`;
            xml += `\t\t<TaxGroupID>${r.TaxGroupID}</TaxGroupID>\n`;
            xml += `\t\t<UpdateStockFlag>${r.UpdateStockFlag || 'true'}</UpdateStockFlag>\n`;
            xml += `\t\t<BaseUOMCode>${r.BaseUOMCode}</BaseUOMCode>\n`;
            xml += `\t\t<MinimumShelfLifeDayCount>${r.MinimumShelfLifeDayCount || '0'}</MinimumShelfLifeDayCount>\n`;
            xml += `\t\t<ClassCode>${r.ClassCode || 'HAWA'}</ClassCode>\n`;
            xml += `\t\t<TaxExemptCode>${r.TaxExemptCode || '00'}</TaxExemptCode>\n`;
            xml += `\t\t<WarrantyPeriod>${r.WarrantyPeriod || '0'}</WarrantyPeriod>\n`;
            xml += `\t\t<LabelType>${r.LabelType || 'HAWA'}</LabelType>\n`;
            xml += `\t\t<ItemUsageTypeCode>${r.ItemUsageTypeCode || '00'}</ItemUsageTypeCode>\n`;
            xml += `\t\t<MerchandiseHierarchyGroupAssignment>\n\t\t\t<MerchandiseHierarchyGroupID>${r.MerchandiseHierarchyGroupID}</MerchandiseHierarchyGroupID>\n\t\t</MerchandiseHierarchyGroupAssignment>\n`;
            xml += `\t\t<RegularSalesUnitPrice>${r.RegularSalesUnitPrice}</RegularSalesUnitPrice>\n`;
            xml += `\t</Item>\n`;
        });
        xml += `</ItemList>`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([xml], {type: 'text/xml'}));
        a.download = "ItemMasterData_Mirror_Export.xml"; a.click();
    }

    function escapeXml(s) { return s.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','"':'&quot;'}[c])); }
    function dragStart(e,k) { e.dataTransfer.setData("text", k); }
    function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
    function drop(e,col) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); MASTER.currentMap[col] = e.dataTransfer.getData("text"); applyMasterMapping(); }
    function resetMasterMapping() { MASTER.currentMap = {...MASTER.defaultMap}; applyMasterMapping(); }

    document.getElementById('div-master').addEventListener('mousedown', (e) => {
        e.preventDefault(); const startY = e.clientY; const startH = document.getElementById('panel-master-top').offsetHeight;
        const mm = (ev) => document.getElementById('panel-master-top').style.flex = `0 0 ${Math.max(50, startH + (ev.clientY - startY))}px`;
        const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
        document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
    });
</script>
</body>
</html>
